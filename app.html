<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SalesFlow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00CEC8;
            --primary-dark: #00B8B3;
            --secondary: #00A8A3;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            --primary: #00CEC8;
            --primary-dark: #00E5DD;
            --secondary: #00D9D3;
            --success: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            padding: 2rem 1.5rem;
            z-index: 101;
            overflow-y: auto;
            box-shadow: 4px 0 12px var(--shadow);
        }

        .sidebar-logo {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
        }

        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            font-weight: 600;
            margin: 1.5rem 0 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }

        .action-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
            background: transparent;
            color: var(--text-primary);
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            transform: translateX(4px);
        }

        .action-btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .btn-meeting .action-btn-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-preparation .action-btn-icon {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            box-shadow: 0 4px 12px rgba(250, 112, 154, 0.3);
        }

        .btn-new-task .action-btn-icon {
            background: linear-gradient(135deg, #56d364 0%, #3fb950 100%);
            box-shadow: 0 4px 12px rgba(86, 211, 100, 0.3);
        }

        .btn-new-note .action-btn-icon {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
        }

        .btn-show-tasks .action-btn-icon {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .btn-home .action-btn-icon {
            background: linear-gradient(135deg, #00CEC8 0%, #00A8A3 100%);
            box-shadow: 0 4px 12px rgba(0, 206, 200, 0.3);
        }

        .btn-meeting:hover .action-btn-icon,
        .btn-preparation:hover .action-btn-icon {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-new-task:hover .action-btn-icon {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(86, 211, 100, 0.4);
        }

        .btn-show-tasks:hover .action-btn-icon {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(79, 172, 254, 0.4);
        }

        .btn-new-note:hover .action-btn-icon {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(240, 147, 251, 0.4);
        }

        .btn-home:hover .action-btn-icon {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 206, 200, 0.4);
        }

        .action-btn-icon svg {
            width: 20px;
            height: 20px;
            stroke: white;
            fill: none;
            stroke-width: 2;
        }

        .category-filter {
            padding: 0.75rem 1rem;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            justify-content: space-between;
        }

        .category-filter:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        .category-filter.active {
            background: var(--primary);
            color: white;
        }

        .category-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .customer-count {
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
        }

        .category-filter.active .customer-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .sidebar-stats {
            margin-top: 2rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 600;
            color: var(--primary);
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            margin-left: var(--sidebar-width);
            z-index: 100;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            background: transparent;
            border: none;
            padding: 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-icon.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .btn-icon svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Main Container */
        .container {
            margin-left: var(--sidebar-width);
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
        }

        .container.kanban-mode {
            grid-template-columns: 1fr;
        }

        /* Main Content Area */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Customer Overview Section */
        .customer-overview-section {
            display: none;
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .customer-overview-section.active {
            display: block;
        }

        .customer-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .customer-overview-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .customer-overview-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px var(--shadow);
            border-color: var(--primary);
        }

        .customer-overview-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .customer-overview-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .customer-overview-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .customer-overview-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .customer-overview-badge.meetings {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .customer-overview-badge.preparations {
            background: rgba(250, 112, 154, 0.15);
            color: #fa709a;
        }

        .customer-overview-badge.tasks {
            background: rgba(0, 206, 200, 0.15);
            color: var(--primary);
        }

        .customer-overview-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .customer-overview-info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .customer-overview-label {
            color: var(--text-secondary);
        }

        .customer-overview-value {
            font-weight: 600;
        }

/* Customer Preparations Section */
.customer-preparations-section {
    display: none;
    background: var(--bg-primary);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 8px var(--shadow);
    margin-bottom: 2rem;
}

.customer-preparations-section.active {
    display: block;
}

.customer-preparations-section.empty {
    padding: 1rem;
    background: transparent;
    box-shadow: none;
}

/* Customer Meeting Notes Section */
.customer-meetings-section {
    display: none;
    background: var(--bg-primary);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 8px var(--shadow);
}

.customer-meetings-section.active {
    display: block;
}

.customer-meetings-section.empty {
    padding: 1rem;
    background: transparent;
    box-shadow: none;
}

/* Compact Empty State */
.empty-state-compact {
    text-align: center;
    padding: 1rem;
    color: var(--text-secondary);
    background: var(--bg-secondary);
    border-radius: 12px;
    font-size: 0.9rem;
    border: 2px dashed var(--border);
}

.empty-state-compact-icon {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
    opacity: 0.5;
}

.empty-state-add-btn {
    margin-top: 0.75rem;
    padding: 0.5rem 1rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.empty-state-add-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}
        .customer-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .customer-section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .customer-meeting-summary {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        .customer-preparation-summary {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #fa709a;
        }

        .meeting-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .meeting-summary-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .meeting-summary-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .meeting-summary-content {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            white-space: pre-wrap;
            max-height: 100px;
            overflow: hidden;
            position: relative;
            padding: 0;
            margin-left: 0;
            padding-left: 0;
            text-align: left;
            word-wrap: break-word;
        }

        .meeting-summary-content.expanded {
            max-height: none;
        }

        .meeting-expand-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.5rem 0;
            transition: all 0.2s;
        }

        .meeting-expand-btn:hover {
            color: var(--primary-dark);
        }

        /* Participants List */
        .participants-list {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .participant-item {
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .participant-role {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .btn-remove-participant {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Preparation Badge */
        .preparation-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* MEDDPICC Progress Bar */
        .meddpicc-progress {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
        }

        .meddpicc-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .meddpicc-progress-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .meddpicc-progress-score {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .meddpicc-progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .meddpicc-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .meddpicc-items {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .meddpicc-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .meddpicc-item-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .meddpicc-item-icon.completed {
            background: var(--success);
            color: white;
        }

        .meddpicc-item-icon.incomplete {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        /* MEDDPICC Section in Meeting Card */
        .meddpicc-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border);
        }

        .meddpicc-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meddpicc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .meddpicc-field {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
        }

        .meddpicc-field-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .meddpicc-field-value {
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        .meddpicc-field.empty .meddpicc-field-value {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Tasks Section */
        .tasks-section {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .section-title-customer {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .task-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Kanban Board */
        .kanban-board {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .kanban-board.active {
            display: grid;
        }

        .kanban-column {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            min-height: 500px;
        }

        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .kanban-column-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kanban-column-count {
            background: var(--bg-tertiary);
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .kanban-cards {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 400px;
        }

        .kanban-cards.drag-over {
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px dashed var(--primary);
        }

        /* Task Card */
        .task-card {
            background: var(--bg-secondary);
            border: 3px solid transparent;
            border-radius: 14px;
            padding: 1.25rem;
            cursor: move;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            gap: 1rem;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task-card:hover {
            box-shadow: 0 8px 20px var(--shadow);
            transform: translateY(-4px) scale(1.01);
        }

        .task-card.overdue {
            border-left: 4px solid var(--danger);
        }

        .task-card.due-soon {
            border-left: 4px solid var(--warning);
        }

        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg) scale(1.05);
            box-shadow: 0 10px 30px var(--shadow);
        }

        /* Color Outline Classes */
        .task-card.color-red { border-color: #ef4444; }
        .task-card.color-orange { border-color: #f97316; }
        .task-card.color-yellow { border-color: #eab308; }
        .task-card.color-green { border-color: #10b981; }
        .task-card.color-blue { border-color: #3b82f6; }
        .task-card.color-purple { border-color: #8b5cf6; }
        .task-card.color-pink { border-color: #ec4899; }

        .task-number {
            position: absolute;
            top: -10px;
            left: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .task-checkbox {
            width: 32px;
            height: 32px;
            border: 2.5px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .task-checkbox:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .task-checkbox.completed {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
        }

        .task-checkbox svg {
            width: 18px;
            height: 18px;
            stroke: white;
            stroke-width: 3;
            fill: none;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s;
        }

        .task-checkbox.completed svg {
            opacity: 1;
            transform: scale(1);
        }

        .task-content {
            flex: 1;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .task-title {
            font-size: 1.1rem;
            font-weight: 600;
            flex: 1;
        }

        .task-title.completed {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .task-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .task-priority, .task-category {
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .priority-low {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .task-customer {
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
        }

        .task-meeting-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .task-due-date {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            width: fit-content;
        }

        .task-due-date.overdue {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            font-weight: 600;
        }

        .task-due-date.due-soon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            font-weight: 600;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .subtasks-container {
            margin: 0.75rem 0;
            padding-left: 1rem;
            border-left: 2px solid var(--border);
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .subtask-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .subtask-checkbox.completed {
            background: var(--primary);
            border-color: var(--primary);
        }

        .subtask-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            gap: 1rem;
        }

        .task-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .tag {
            padding: 0.25rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .task-actions {
            display: flex;
            gap: 0.25rem;
        }

        .task-btn {
            background: transparent;
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .task-btn:hover {
            background: var(--bg-tertiary);
            color: var(--primary);
        }

        .task-btn.delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .task-btn.archive:hover {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .task-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Color Picker */
        .color-picker {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .color-option.selected {
            border: 3px solid var(--text-primary);
            transform: scale(1.1);
        }

        /* Notes Section */
        .notes-container {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
            position: sticky;
            top: 100px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .notes-container.hidden {
            display: none;
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .note-box {
            border-radius: 14px;
            padding: 1.5rem;
            color: white;
            cursor: move;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        .note-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .note-box.dragging {
            opacity: 0.7;
        }

        .note-number {
            position: absolute;
            top: -10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .note-content {
            margin-bottom: 1rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .note-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .note-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .note-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .note-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Meeting Card */
        .meeting-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .meeting-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .meeting-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .meeting-notes {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }

        .meeting-tasks {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .meeting-tasks-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .meeting-task-item {
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        /* Meeting Tags */
        .meeting-tags-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .meeting-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .modal-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .modal-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Export Content */
        .export-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .export-preview {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .export-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-export {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--primary);
            color: white;
        }

        .btn-export:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Tags Overview Modal */
        .tags-overview-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            max-height: 70vh;
        }

        .tags-list-section {
            border-right: 1px solid var(--border);
            padding-right: 2rem;
            overflow-y: auto;
        }

        .tag-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        .tag-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .tag-item-name {
            font-weight: 600;
        }

        .tag-item-count {
            font-size: 0.85rem;
            background: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .tag-item.active .tag-item-count {
            background: rgba(255, 255, 255, 0.2);
        }

        .customers-by-tag-section {
            overflow-y: auto;
        }

        .customer-tag-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .customer-tag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .customer-tag-name {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .meetings-count-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .meetings-list-compact {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .meeting-compact-item {
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .meeting-compact-date {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: auto;
        }

        .modal-content.large {
            max-width: 900px;
        }

        .modal-content.xlarge {
            max-width: 1400px;
            width: 95%;
            max-height: 90vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--bg-secondary);
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .form-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }

        .subtasks-form {
            margin-top: 0.5rem;
        }

        .subtask-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .subtask-input {
            flex: 1;
        }

        .btn-add-subtask {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .btn-add-subtask:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-remove-subtask {
            padding: 0.5rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .form-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        /* Customer Combobox */
        .customer-combobox {
            position: relative;
        }

        .customer-combobox-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .customer-combobox-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 206, 200, 0.1);
        }

        .customer-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 10;
        }

        .customer-dropdown.active {
            display: block;
        }

        .customer-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .customer-dropdown-item:last-child {
            border-bottom: none;
        }

        .customer-dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .customer-dropdown-item.new-customer {
            color: var(--primary);
            font-weight: 600;
        }

        .customer-dropdown-item-name {
            font-weight: 500;
        }

        .customer-dropdown-item-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* MEDDPICC Grid in Form */
        .meddpicc-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Meeting Tasks in Modal */
        .meeting-tasks-list {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .meeting-task-preview {
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-remove-meeting-task {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Customer List */
        .customer-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .customer-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-info {
            flex: 1;
        }

        .customer-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .customer-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .customer-actions {
            display: flex;
            gap: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 8px 24px var(--shadow);
            z-index: 1001;
            transition: transform 0.3s;
        }

        .toast.active {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        /* Confirmation Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeInConfirm {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .confirm-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .confirm-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            .notes-container {
                position: relative;
                top: 0;
                max-height: none;
            }
            .kanban-board {
                grid-template-columns: 1fr;
            }
            .form-row-3, .form-row-4 {
                grid-template-columns: 1fr;
            }
            .tags-overview-content {
                grid-template-columns: 1fr;
            }
            .tags-list-section {
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding-right: 0;
                padding-bottom: 1rem;
                margin-bottom: 1rem;
            }
            .meddpicc-items {
                grid-template-columns: repeat(2, 1fr);
            }
            .meddpicc-grid, .meddpicc-form-grid {
                grid-template-columns: 1fr;
            }
            .customer-overview-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            :root {
                --sidebar-width: 0;
            }
            .sidebar {
                transform: translateX(-100%);
            }
            .header, .container {
                margin-left: 0;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .modal-content.xlarge, .modal-content.large {
                width: 95%;
                padding: 1.5rem;
            }
            .modal-tabs {
                overflow-x: scroll;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
<div class="sidebar-logo">SalesFlow</div>

        <button class="action-btn btn-home" id="homeBtn" style="margin-bottom: 1.5rem;">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <span>Home</span>
        </button>

        <div class="sidebar-title">Quick Actions</div>
        <button class="action-btn btn-preparation" id="newPreparationBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M9 11l3 3L22 4"></path>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
            </div>
            <span>Prepare for Meeting</span>
        </button>
        <button class="action-btn btn-meeting" id="newMeetingBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <span>Meeting Notes</span>
        </button>
        <button class="action-btn btn-new-task" id="newTaskBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>
            <span>New Task</span>
        </button>
        <button class="action-btn btn-new-note" id="newNoteBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
            </div>
            <span>Quick Note</span>
        </button>
        <button class="action-btn btn-show-tasks" id="showAllTasksBtn">
            <div class="action-btn-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M9 11l3 3L22 4"></path>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
            </div>
            <span>Show All Tasks</span>
        </button>

        <div class="sidebar-title">
            <span>Customers</span>
            <button class="sidebar-title-btn" id="manageCustomersBtn" title="Manage Customers">+</button>
        </div>
        <button class="category-filter active" data-customer="all">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span class="category-dot" style="background: var(--primary)"></span>
                All Customers
            </div>
            <span class="customer-count" id="allCustomersCount">0</span>
        </button>
        <div id="customerFilters"></div>

        <div class="sidebar-stats">
            <div class="stat-item">
                <span class="stat-label">Total Tasks</span>
                <span class="stat-value" id="statTotal">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Active</span>
                <span class="stat-value" id="statActive">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Completed</span>
                <span class="stat-value" id="statCompleted">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Meetings</span>
                <span class="stat-value" id="statMeetings">0</span>
            </div>
        </div>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="search-bar">
                <span class="search-icon"></span>
                <input type="text" id="searchInput" placeholder="Search tasks, meetings, customers...">
            </div>
            <div class="header-actions">
                <button class="btn-icon" id="tagsOverviewBtn" title="Tags Overview">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                </button>
                <button class="btn-icon" id="viewMeetingsBtn" title="View All Meetings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </button>
                <button class="btn-icon" id="themeToggle" title="Toggle Theme">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="btn-icon" id="archiveBtn" title="View Archive">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                        <rect x="1" y="3" width="22" height="5"></rect>
                        <line x1="10" y1="12" x2="14" y2="12"></line>
                    </svg>
                </button>
                <button class="btn-icon danger" id="clearAllBtn" title="Clear All Data">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container" id="mainContainer">
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Customer Overview Section -->
            <div class="customer-overview-section" id="customerOverviewSection">
                <div class="section-header">
                    <h2 class="section-title">Customer Overview</h2>
                </div>
                <div class="customer-overview-grid" id="customerOverviewGrid"></div>
                <div class="empty-state" id="customerOverviewEmpty" style="display: none;">
                    <div class="empty-state-icon"></div>
                    <div>No customers with meetings or preparations yet</div>
                </div>
            </div>

            <!-- Customer Preparations Section -->
            <div class="customer-preparations-section" id="customerPreparationsSection">
                <div class="customer-section-header">
                    <h3 class="customer-section-title"> Meeting Preparations</h3>
                </div>
                <div id="customerPreparationsList"></div>
                <div class="empty-state" id="customerPreparationsEmpty" style="display: none;">
                    <div class="empty-state-icon"></div>
                    <div>No preparations for this customer</div>
                </div>
            </div>

            <!-- Customer Meeting Notes Section -->
            <div class="customer-meetings-section" id="customerMeetingsSection">
                <div class="customer-section-header">
                    <h3 class="customer-section-title"> Meeting Notes</h3>
                </div>
                <div id="customerMeetingsList"></div>
                <div class="empty-state" id="customerMeetingsEmpty" style="display: none;">
                    <div class="empty-state-icon"></div>
                    <div>No meetings for this customer</div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="tasks-section">
                <div class="section-header">
                    <h2 class="section-title" id="mainSectionTitle">Tasks</h2>
                    <div class="view-toggle">
                        <button class="view-btn" data-view="list"> List</button>
                        <button class="view-btn" data-view="kanban"> Kanban</button>
                        <button class="view-btn active" data-view="active">Active</button>
                        <button class="view-btn" data-view="archived">Archived</button>
                    </div>
                </div>

                <div class="task-filters" id="taskFilters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="today">Today</button>
                    <button class="filter-btn" data-filter="week">This Week</button>
                    <button class="filter-btn" data-filter="overdue">Overdue</button>
                    <button class="filter-btn" data-filter="high">High Priority</button>
                </div>

                <!-- List View -->
                <div class="tasks-list" id="tasksList"></div>

                <!-- Kanban Board -->
                <div class="kanban-board" id="kanbanBoard">
                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                 To Do
                            </div>
                            <div class="kanban-column-count" id="todoCount">0</div>
                        </div>
                        <div class="kanban-cards" id="todoColumn" data-status="todo"></div>
                    </div>

                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                 In Progress
                            </div>
                            <div class="kanban-column-count" id="progressCount">0</div>
                        </div>
                        <div class="kanban-cards" id="progressColumn" data-status="in-progress"></div>
                    </div>

                    <div class="kanban-column">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                 Done
                            </div>
                            <div class="kanban-column-count" id="doneCount">0</div>
                        </div>
                        <div class="kanban-cards" id="doneColumn" data-status="done"></div>
                    </div>
                </div>

                <div class="empty-state" id="tasksEmpty" style="display: none;">
                    <div class="empty-state-icon"></div>
                    <div>No tasks yet</div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-container" id="notesContainer">
            <div class="section-header">
                <h2 class="section-title">Quick Notes</h2>
            </div>
            <div class="notes-list" id="notesList"></div>
            <div class="empty-state" id="notesEmpty" style="display: none;">
                <div class="empty-state-icon"></div>
                <div>No notes yet</div>
            </div>
        </div>
    </div>

    <!-- Tags Overview Modal -->
    <div class="modal" id="tagsOverviewModal">
        <div class="modal-content xlarge">
            <div class="modal-header">
                <h3 class="modal-title"> Tags Overview</h3>
                <button class="close-btn" id="closeTagsOverviewBtn"></button>
            </div>
            <div class="tags-overview-content">
                <div class="tags-list-section">
                    <h4 style="margin-bottom: 1rem;">All Tags</h4>
                    <div id="tagsListContainer"></div>
                    <div class="empty-state" id="tagsEmpty" style="display: none; padding: 2rem 0;">
                        <div class="empty-state-icon"></div>
                        <div>No tags yet</div>
                    </div>
                </div>
                <div class="customers-by-tag-section">
                    <h4 style="margin-bottom: 1rem;" id="selectedTagTitle">Select a tag to view customers</h4>
                    <div id="customersByTagContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Management Modal -->
    <div class="modal" id="customersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manage Customers</h3>
                <button class="close-btn" id="closeCustomersModalBtn"></button>
            </div>
            <button class="btn btn-primary" id="openAddCustomerBtn" style="margin-bottom: 1rem; width: 100%;">+ Add New Customer</button>
            <div class="customer-list" id="customerList"></div>
            <div class="empty-state" id="customersEmpty" style="display: none;">
                <div class="empty-state-icon"></div>
                <div>No customers yet</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    <div class="modal" id="customerFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="customerFormTitle">Add Customer</h3>
                <button class="close-btn" id="closeCustomerFormBtn"></button>
            </div>
            <form id="customerForm">
                <input type="hidden" id="customerId">
                <div class="form-group">
                    <label class="form-label">Customer Name *</label>
                    <input type="text" class="form-input" id="customerName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="customerEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="customerPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" id="customerCompany">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="customerNotes"></textarea>
                </div>
                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelCustomerFormBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Meeting Preparation Modal -->
    <div class="modal" id="preparationModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title"> Prepare for Meeting</h3>
                <button class="close-btn" id="closePreparationModalBtn"></button>
            </div>

            <!-- Modal Tabs -->
            <div class="modal-tabs">
                <button type="button" class="modal-tab active" data-tab="info">
                     Preparation
                </button>
                <button type="button" class="modal-tab" data-tab="export">
                     Export
                </button>
            </div>

            <form id="preparationForm">
                <input type="hidden" id="preparationId">
                
                <!-- Tab 1: Preparation -->
                <div class="tab-content active" data-tab-content="info">
                    <div class="form-group">
                        <label class="form-label">Customer Name *</label>
                        <div class="customer-combobox">
                            <input 
                                type="text" 
                                class="customer-combobox-input" 
                                id="preparationCustomerInput" 
                                placeholder="Type to add new or select existing customer..."
                                autocomplete="off"
                                required
                            >
                            <div class="customer-dropdown" id="preparationCustomerDropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Meeting Purpose/Goals *</label>
                        <textarea class="form-textarea" id="preparationGoals" required placeholder="What do you want to achieve in this meeting?"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Key Discussion Points</label>
                        <textarea class="form-textarea" id="preparationDiscussionPoints" placeholder="Topics to cover, questions to ask..." style="min-height: 150px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Background/Context</label>
                        <textarea class="form-textarea" id="preparationBackground" placeholder="Previous interactions, current status, important context..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Materials/Resources Needed</label>
                        <textarea class="form-textarea" id="preparationMaterials" placeholder="Documents, demos, presentations to prepare..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Expected Outcomes</label>
                        <textarea class="form-textarea" id="preparationOutcomes" placeholder="What should be decided or achieved by the end?"></textarea>
                    </div>
                </div>

                <!-- Tab 2: Export -->
                <div class="tab-content" data-tab-content="export">
                    <div class="export-content">
                        <h4 style="margin-bottom: 1rem;">Export Preparation</h4>
                        <div class="export-preview" id="preparationExportPreview">
                            Preview will appear here...
                        </div>
                        <div class="export-actions">
                            <button type="button" class="btn-export" id="copyPreparationBtn"> Copy to Clipboard</button>
                            <button type="button" class="btn-export" id="downloadPreparationBtn"> Download as Text</button>
                        </div>
                    </div>
                </div>

                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelPreparationBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary"> Save Preparation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Meeting Notes Modal with Tabs -->
    <div class="modal" id="meetingModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title"> Meeting Notes</h3>
                <button class="close-btn" id="closeMeetingModalBtn"></button>
            </div>

            <!-- Modal Tabs -->
            <div class="modal-tabs">
                <button type="button" class="modal-tab active" data-tab="info">
                     Meeting Info
                </button>
                <button type="button" class="modal-tab" data-tab="preparation" id="preparationTab" style="display: none;">
                     Preparation
                </button>
                <button type="button" class="modal-tab" data-tab="notes">
                     Notes
                </button>
                <button type="button" class="modal-tab" data-tab="meddpicc">
                     MEDDPICC
                </button>
                <button type="button" class="modal-tab" data-tab="actions">
                     Action Items
                </button>
                <button type="button" class="modal-tab" data-tab="export">
                     Export
                </button>
            </div>

            <form id="meetingForm">
                <input type="hidden" id="meetingId">
                
                <!-- Tab 1: Meeting Info -->
                <div class="tab-content active" data-tab-content="info">
                    <div class="form-group">
                        <label class="form-label">Customer Name *</label>
                        <div class="customer-combobox">
                            <input 
                                type="text" 
                                class="customer-combobox-input" 
                                id="meetingCustomerInput" 
                                placeholder="Type to add new or select existing customer..."
                                autocomplete="off"
                                required
                            >
                            <div class="customer-dropdown" id="customerDropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Meeting Title *</label>
                        <input type="text" class="form-input" id="meetingTitle" required placeholder="e.g., Q4 Strategy Discussion">
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label class="form-label">Meeting Date *</label>
                            <input type="datetime-local" class="form-input" id="meetingDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Meeting Type *</label>
                            <select class="form-select" id="meetingType" required>
                                <option value="discovery">Discovery Call</option>
                                <option value="demo">Product Demo</option>
                                <option value="follow-up">Follow-up</option>
                                <option value="quarterly">Quarterly Review</option>
                                <option value="onboarding">Onboarding</option>
                                <option value="support">Support Call</option>
                                <option value="sales">Sales Meeting</option>
                                <option value="strategy">Strategy Session</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Duration (mins)</label>
                            <input type="number" class="form-input" id="meetingDuration" placeholder="60" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Participants</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" class="form-input" id="participantNameInput" placeholder="Name">
                            <input type="text" class="form-input" id="participantRoleInput" placeholder="Role/Title">
                            <button type="button" class="btn btn-primary" id="addParticipantBtn" style="white-space: nowrap;">+ Add</button>
                        </div>
                        <div class="participants-list" id="participantsList"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" class="form-input" id="meetingFollowUpDate">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Meeting Outcome</label>
                            <select class="form-select" id="meetingOutcome">
                                <option value="">Select outcome...</option>
                                <option value="positive"> Positive - Moving Forward</option>
                                <option value="neutral"> Neutral - Needs More Discussion</option>
                                <option value="negative"> Not Interested</option>
                                <option value="pending"> Pending Decision</option>
                                <option value="won"> Deal Won</option>
                                <option value="lost"> Deal Lost</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Preparation (if exists) -->
                <div class="tab-content" data-tab-content="preparation">
                    <div id="preparationContent" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                        <p style="color: var(--text-secondary); text-align: center;">No preparation found for this customer</p>
                    </div>
                </div>

               <!-- Tab 3: Meeting Notes -->
                <div class="tab-content" data-tab-content="notes">
                    <div class="form-group">
                        <label class="form-label">Services Discussed</label>
                        <textarea class="form-textarea" id="meetingServices" placeholder="List the services or products discussed in this meeting..." style="min-height: 100px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Meeting Notes *</label>
                        <textarea class="form-textarea" id="meetingNotes" required style="min-height: 250px;" placeholder="Take detailed meeting notes here...&#10;&#10; Key discussion points&#10; Decisions made&#10; Customer feedback&#10; Next steps"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Next Steps</label>
                        <textarea class="form-textarea" id="meetingNextSteps" placeholder="What are the immediate next steps?&#10;&#10; Schedule follow-up&#10; Send proposal&#10; Prepare materials" style="min-height: 150px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-input" id="meetingTags" placeholder="e.g., renewal, upsell, support">
                        <small style="color: var(--text-secondary); font-size: 0.85rem;">Use tags to categorize meetings for easy filtering</small>
                    </div>
                </div>

                <!-- Tab 4: MEDDPICC -->
                <div class="tab-content" data-tab-content="meddpicc">
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-style: italic;">
                        Fill in these fields to ensure proper sales qualification
                    </p>

                    <div class="meddpicc-form-grid">
                        <div class="form-group">
                            <label class="form-label"> Metrics</label>
                            <textarea class="form-textarea" id="meddpiccMetrics" placeholder="What quantifiable benefits/ROI are we delivering?&#10;e.g., Save $100K annually, increase efficiency by 30%" style="min-height: 100px;"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label"> Economic Buyer</label>
                            <input type="text" class="form-input" id="meddpiccEconomicBuyer" placeholder="Who controls the budget? (Name & Title)">
                        </div>

                        <div class="form-group">
                            <label class="form-label"> Decision Criteria</label>
                            <textarea class="form-textarea" id="meddpiccDecisionCriteria" placeholder="What are their formal evaluation criteria?&#10;e.g., Price, features, integration capabilities" style="min-height: 100px;"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label"> Decision Process</label>
                            <textarea class="form-textarea" id="meddpiccDecisionProcess" placeholder="What is their buying process?&#10;e.g., Demo  Proposal  Legal Review  Board Approval" style="min-height: 100px;"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label"> Paper Process</label>
                            <textarea class="form-textarea" id="meddpiccPaperProcess" placeholder="What is the contract/legal process?&#10;e.g., MSA required, security review, procurement" style="min-height: 100px;"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label"> Identify Pain</label>
                            <textarea class="form-textarea" id="meddpiccPain" placeholder="What problems are they trying to solve?&#10;e.g., Manual processes, data silos, compliance issues" style="min-height: 100px;"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label"> Champion</label>
                            <input type="text" class="form-input" id="meddpiccChampion" placeholder="Who will sell internally for us? (Name & Title)">
                        </div>

                        <div class="form-group">
                            <label class="form-label"> Competition</label>
                            <textarea class="form-textarea" id="meddpiccCompetition" placeholder="Who else are they considering?&#10;e.g., Competitor A (price focused), Competitor B (enterprise)" style="min-height: 100px;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Tab 5: Action Items & Next Steps -->
                <div class="tab-content" data-tab-content="actions">
                    <div class="form-group">
                        <label class="form-label">Action Items / Tasks</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" class="form-input" id="quickTaskInput" placeholder="Add action item or task...">
                            <button type="button" class="btn btn-primary" id="addQuickTaskBtn" style="white-space: nowrap;">+ Add</button>
                        </div>
                        <div class="meeting-tasks-list" id="meetingTasksList"></div>
                    </div>
                </div>

                <!-- Tab 6: Export -->
                <div class="tab-content" data-tab-content="export">
                    <div class="export-content">
                        <h4 style="margin-bottom: 1rem;">Export Meeting Notes</h4>
                        <div class="export-preview" id="meetingExportPreview">
                            Preview will appear here...
                        </div>
                        <div class="export-actions">
                            <button type="button" class="btn-export" id="copyMeetingBtn"> Copy to Clipboard</button>
                            <button type="button" class="btn-export" id="downloadMeetingBtn"> Download as Text</button>
                        </div>
                    </div>
                </div>

                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelMeetingBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary"> Save Meeting Notes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View All Meetings Modal -->
    <div class="modal" id="allMeetingsModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">All Meetings</h3>
                <button class="close-btn" id="closeAllMeetingsBtn"></button>
            </div>
            <div id="allMeetingsList"></div>
            <div class="empty-state" id="meetingsEmpty" style="display: none;">
                <div class="empty-state-icon"></div>
                <div>No meetings yet</div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Task</h3>
                <button class="close-btn" id="closeTaskModalBtn"></button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <input type="hidden" id="taskMeetingId">
                
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="taskDescription" placeholder="Press Enter for new lines..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Customer</label>
                    <div class="customer-combobox">
                        <input 
                            type="text" 
                            class="customer-combobox-input" 
                            id="taskCustomerInput" 
                            placeholder="Type to add new or select existing customer..."
                            autocomplete="off"
                        >
                        <div class="customer-dropdown" id="taskCustomerDropdown"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="taskStatus">
                            <option value="todo">To Do</option>
                            <option value="in-progress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="taskDueDate">
                </div>

                <div class="form-group">
                    <label class="form-label">Color Outline</label>
                    <div class="color-picker">
                        <div class="color-option" data-color="none" style="background: var(--bg-tertiary)"></div>
                        <div class="color-option" data-color="red" style="background: #ef4444"></div>
                        <div class="color-option" data-color="orange" style="background: #f97316"></div>
                        <div class="color-option" data-color="yellow" style="background: #eab308"></div>
                        <div class="color-option" data-color="green" style="background: #10b981"></div>
                        <div class="color-option" data-color="blue" style="background: #3b82f6"></div>
                        <div class="color-option" data-color="purple" style="background: #8b5cf6"></div>
                        <div class="color-option" data-color="pink" style="background: #ec4899"></div>
                    </div>
                    <input type="hidden" id="taskColor" value="none">
                </div>

                <div class="form-group">
                    <label class="form-label">Tags (comma-separated)</label>
                    <input type="text" class="form-input" id="taskTags">
                </div>

                <div class="form-group">
                    <label class="form-label">Subtasks</label>
                    <div class="subtasks-form" id="subtasksForm"></div>
                    <button type="button" class="btn-add-subtask" id="addSubtaskBtn">+ Add Subtask</button>
                </div>

                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelTaskBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Note</h3>
                <button class="close-btn" id="closeNoteModalBtn"></button>
            </div>
            <form id="noteForm">
                <input type="hidden" id="noteId">
                <div class="form-group">
                    <label class="form-label">Note Content *</label>
                    <textarea class="form-textarea" id="noteContent" required style="min-height: 150px;" placeholder="Press Enter for new lines..."></textarea>
                </div>
                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" id="cancelNoteBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-icon" id="confirmIcon"></div>
            <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
            <p class="confirm-message" id="confirmMessage">Are you sure?</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" id="cancelConfirmBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        const state = {
            tasks: [],
            notes: [],
            customers: [],
            meetings: [],
            preparations: [],
            currentCategory: 'all',
            currentCustomer: 'all',
            currentFilter: 'all',
            currentView: 'active',
            currentDisplayMode: 'list',
            editingTask: null,
            editingNote: null,
            editingCustomer: null,
            editingMeeting: null,
            editingPreparation: null,
            selectedColor: 'none',
            confirmCallback: null,
            meetingTasks: [],
            meetingParticipants: [],
            selectedCustomerId: null,
            selectedTaskCustomerId: null,
            selectedPreparationCustomerId: null,
            selectedTag: null,
            currentMeetingTab: 'info',
            currentPreparationTab: 'info'
        };

        // Initialize
        function init() {
            loadData();
            setupEventListeners();
            setupColorPicker();
            setupCustomerCombobox();
            setupTaskCustomerCombobox();
            setupPreparationCustomerCombobox();
            setupMeetingTabs();
            setupPreparationTabs();
            updateStats();
            renderCustomerFilters();
            showHome();
        }

        function setupEventListeners() {
            // Main action buttons
            document.getElementById('homeBtn').addEventListener('click', () => showHome());
            document.getElementById('showAllTasksBtn').addEventListener('click', () => showAllTasks());
            document.getElementById('newPreparationBtn').addEventListener('click', () => openPreparationModal());
            document.getElementById('newMeetingBtn').addEventListener('click', () => openMeetingModal());
            document.getElementById('newTaskBtn').addEventListener('click', () => openTaskModal());
            document.getElementById('newNoteBtn').addEventListener('click', () => openNoteModal());
            document.getElementById('manageCustomersBtn').addEventListener('click', () => openCustomersModal());
            document.getElementById('viewMeetingsBtn').addEventListener('click', () => openAllMeetingsModal());
            document.getElementById('tagsOverviewBtn').addEventListener('click', () => openTagsOverviewModal());
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('archiveBtn').addEventListener('click', () => showArchived());
            document.getElementById('clearAllBtn').addEventListener('click', () => showConfirm(
                '',
                'Clear All Data?',
                'This will permanently delete all tasks, notes, customers, meetings, and preparations. This action cannot be undone.',
                confirmClearAll
            ));
            
            // Form submissions
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
            document.getElementById('noteForm').addEventListener('submit', handleNoteSubmit);
            document.getElementById('customerForm').addEventListener('submit', handleCustomerSubmit);
            document.getElementById('meetingForm').addEventListener('submit', handleMeetingSubmit);
            document.getElementById('preparationForm').addEventListener('submit', handlePreparationSubmit);
            
            // Search
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            // Modal close buttons
            document.getElementById('closeCustomersModalBtn').addEventListener('click', closeCustomersModal);
            document.getElementById('closeCustomerFormBtn').addEventListener('click', closeCustomerFormModal);
            document.getElementById('closePreparationModalBtn').addEventListener('click', closePreparationModal);
            document.getElementById('closeMeetingModalBtn').addEventListener('click', closeMeetingModal);
            document.getElementById('closeAllMeetingsBtn').addEventListener('click', closeAllMeetingsModal);
            document.getElementById('closeTaskModalBtn').addEventListener('click', closeTaskModal);
            document.getElementById('closeNoteModalBtn').addEventListener('click', closeNoteModal);
            document.getElementById('closeTagsOverviewBtn').addEventListener('click', closeTagsOverviewModal);

            // Modal cancel buttons
            document.getElementById('cancelCustomerFormBtn').addEventListener('click', closeCustomerFormModal);
            document.getElementById('cancelPreparationBtn').addEventListener('click', closePreparationModal);
            document.getElementById('cancelMeetingBtn').addEventListener('click', closeMeetingModal);
            document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);
            document.getElementById('cancelNoteBtn').addEventListener('click', closeNoteModal);
            document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);

            // Export buttons
            document.getElementById('copyPreparationBtn').addEventListener('click', copyPreparationToClipboard);
            document.getElementById('downloadPreparationBtn').addEventListener('click', downloadPreparation);
            document.getElementById('copyMeetingBtn').addEventListener('click', copyMeetingToClipboard);
            document.getElementById('downloadMeetingBtn').addEventListener('click', downloadMeeting);

            // Other buttons
            document.getElementById('openAddCustomerBtn').addEventListener('click', openAddCustomerForm);
            document.getElementById('addQuickTaskBtn').addEventListener('click', addQuickTask);
            document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);
            document.getElementById('addSubtaskBtn').addEventListener('click', () => addSubtaskInput());

            // Enter key on quick task input
            document.getElementById('quickTaskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addQuickTask();
                }
            });

            // Enter key on participant inputs
            document.getElementById('participantRoleInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addParticipant();
                }
            });

            // Customer filter for "all"
            document.querySelector('.category-filter[data-customer="all"]').addEventListener('click', () => {
                document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
                document.querySelector('.category-filter[data-customer="all"]').classList.add('active');
                state.currentCustomer = 'all';
                hideCustomerMeetingsSection();
                hideCustomerPreparationsSection();
                showCustomerOverview();
                updateSectionTitle();
            });

            // Task filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentFilter = btn.dataset.filter;
                    renderTasks();
                });
            });

            // View buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    
                    if (view === 'list' || view === 'kanban') {
                        state.currentDisplayMode = view;
                        document.querySelectorAll('.view-btn[data-view="list"], .view-btn[data-view="kanban"]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        if (view === 'kanban') {
                            document.getElementById('tasksList').style.display = 'none';
                            document.getElementById('kanbanBoard').classList.add('active');
                            document.getElementById('mainContainer').classList.add('kanban-mode');
                            document.getElementById('notesContainer').classList.add('hidden');
                            document.getElementById('taskFilters').style.display = 'none';
                        } else {
                            document.getElementById('tasksList').style.display = 'flex';
                            document.getElementById('kanbanBoard').classList.remove('active');
                            document.getElementById('mainContainer').classList.remove('kanban-mode');
                            document.getElementById('notesContainer').classList.remove('hidden');
                            document.getElementById('taskFilters').style.display = 'flex';
                        }
                    } else {
                        document.querySelectorAll('.view-btn[data-view="active"], .view-btn[data-view="archived"]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        state.currentView = view;
                    }
                    
                    renderTasks();
                });
            });

            // Set default meeting date to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
        }

        // Setup Meeting Tabs
        function setupMeetingTabs() {
            const tabs = document.querySelectorAll('#meetingModal .modal-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Update tab active state
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update content active state
                    document.querySelectorAll('#meetingModal .tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.querySelector(`#meetingModal [data-tab-content="${tabName}"]`).classList.add('active');
                    
                    state.currentMeetingTab = tabName;

                    // Update export preview if on export tab
                    if (tabName === 'export') {
                        updateMeetingExportPreview();
                    }
                });
            });
        }

        // Setup Preparation Tabs
        function setupPreparationTabs() {
            const tabs = document.querySelectorAll('#preparationModal .modal-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Update tab active state
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update content active state
                    document.querySelectorAll('#preparationModal .tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.querySelector(`#preparationModal [data-tab-content="${tabName}"]`).classList.add('active');
                    
                    state.currentPreparationTab = tabName;

                    // Update export preview if on export tab
                    if (tabName === 'export') {
                        updatePreparationExportPreview();
                    }
                });
            });
        }

        // Show All Tasks
        function showAllTasks() {
            state.currentCustomer = 'all';
            document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
            hideCustomerMeetingsSection();
            hideCustomerPreparationsSection();
            hideCustomerOverview();
            document.getElementById('tasks-section');
            updateSectionTitle();
            renderTasks();
        }

        // Show Home
        function showHome() {
            state.currentCustomer = 'all';
            document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
            document.querySelector('.category-filter[data-customer="all"]').classList.add('active');
            hideCustomerMeetingsSection();
            hideCustomerPreparationsSection();
            showCustomerOverview();
            updateSectionTitle();
        }

        // Show Customer Overview
        function showCustomerOverview() {
            hideCustomerMeetingsSection();
            hideCustomerPreparationsSection();
            document.getElementById('customerOverviewSection').classList.add('active');
            renderCustomerOverview();
        }

        function hideCustomerOverview() {
            document.getElementById('customerOverviewSection').classList.remove('active');
        }

        function renderCustomerOverview() {
            const container = document.getElementById('customerOverviewGrid');
            const empty = document.getElementById('customerOverviewEmpty');

            // Get customers that have meetings or preparations
            const customersWithActivity = state.customers.filter(customer => {
                const hasMeetings = state.meetings.some(m => m.customerId === customer.id);
                const hasPreparations = state.preparations.some(p => p.customerId === customer.id);
                return hasMeetings || hasPreparations;
            });

            if (customersWithActivity.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';

            container.innerHTML = customersWithActivity.map(customer => {
                const meetings = state.meetings.filter(m => m.customerId === customer.id);
                const preparations = state.preparations.filter(p => p.customerId === customer.id);
                const tasks = state.tasks.filter(t => t.customerId === customer.id && !t.archived);
                
                const latestMeeting = meetings.length > 0 ? meetings[0] : null;
                const latestMeetingDate = latestMeeting ? new Date(latestMeeting.date) : null;

                return `
                    <div class="customer-overview-card" onclick="selectCustomerFromOverview('${customer.id}')">
                        <div class="customer-overview-header">
                            <div class="customer-overview-name"> ${escapeHtml(customer.name)}</div>
                        </div>
                        <div class="customer-overview-badges">
                            ${meetings.length > 0 ? `<span class="customer-overview-badge meetings">${meetings.length} Meeting${meetings.length > 1 ? 's' : ''}</span>` : ''}
                            ${preparations.length > 0 ? `<span class="customer-overview-badge preparations">${preparations.length} Preparation${preparations.length > 1 ? 's' : ''}</span>` : ''}
                            ${tasks.length > 0 ? `<span class="customer-overview-badge tasks">${tasks.length} Task${tasks.length > 1 ? 's' : ''}</span>` : ''}
                        </div>
                        <div class="customer-overview-info">
                            ${latestMeetingDate ? `
                                <div class="customer-overview-info-item">
                                    <span class="customer-overview-label">Last Meeting:</span>
                                    <span class="customer-overview-value">${latestMeetingDate.toLocaleDateString()}</span>
                                </div>
                            ` : ''}
                            ${customer.company ? `
                                <div class="customer-overview-info-item">
                                    <span class="customer-overview-label">Company:</span>
                                    <span class="customer-overview-value">${escapeHtml(customer.company)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectCustomerFromOverview(customerId) {
            state.currentCustomer = customerId;
            document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
            const customerFilter = document.querySelector(`.category-filter[data-customer="${customerId}"]`);
            if (customerFilter) {
                customerFilter.classList.add('active');
            }
            hideCustomerOverview();
            showCustomerPreparationsSection(customerId);
            showCustomerMeetingsSection(customerId);
            updateSectionTitle();
            renderTasks();
        }

        // Export Functions
        function generatePreparationExport() {
            const customerName = document.getElementById('preparationCustomerInput').value.trim();
            const goals = document.getElementById('preparationGoals').value.trim();
            const discussionPoints = document.getElementById('preparationDiscussionPoints').value.trim();
            const background = document.getElementById('preparationBackground').value.trim();
            const materials = document.getElementById('preparationMaterials').value.trim();
            const outcomes = document.getElementById('preparationOutcomes').value.trim();

            let exportText = `MEETING PREPARATION\n`;
            exportText += `${'='.repeat(50)}\n\n`;
            exportText += `Customer: ${customerName}\n`;
            exportText += `Prepared: ${new Date().toLocaleString()}\n\n`;
            
            if (goals) {
                exportText += `MEETING GOALS\n${'-'.repeat(50)}\n${goals}\n\n`;
            }
            
            if (discussionPoints) {
                exportText += `KEY DISCUSSION POINTS\n${'-'.repeat(50)}\n${discussionPoints}\n\n`;
            }
            
            if (background) {
                exportText += `BACKGROUND/CONTEXT\n${'-'.repeat(50)}\n${background}\n\n`;
            }
            
            if (materials) {
                exportText += `MATERIALS NEEDED\n${'-'.repeat(50)}\n${materials}\n\n`;
            }
            
            if (outcomes) {
                exportText += `EXPECTED OUTCOMES\n${'-'.repeat(50)}\n${outcomes}\n\n`;
            }

            return exportText;
        }

        function updatePreparationExportPreview() {
            const preview = document.getElementById('preparationExportPreview');
            preview.textContent = generatePreparationExport();
        }

        function copyPreparationToClipboard() {
            const exportText = generatePreparationExport();
            navigator.clipboard.writeText(exportText).then(() => {
                showToast('Preparation copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function downloadPreparation() {
            const exportText = generatePreparationExport();
            const customerName = document.getElementById('preparationCustomerInput').value.trim();
            const filename = `preparation_${customerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Preparation downloaded!', 'success');
        }

        function generateMeetingExport() {
            const customerName = document.getElementById('meetingCustomerInput').value.trim();
            const title = document.getElementById('meetingTitle').value.trim();
            const date = document.getElementById('meetingDate').value;
            const type = document.getElementById('meetingType').value;
            const duration = document.getElementById('meetingDuration').value;
            const services = document.getElementById('meetingServices').value.trim();
            const notes = document.getElementById('meetingNotes').value.trim();
            const nextSteps = document.getElementById('meetingNextSteps').value.trim();
            
            const metrics = document.getElementById('meddpiccMetrics').value.trim();
            const economicBuyer = document.getElementById('meddpiccEconomicBuyer').value.trim();
            const decisionCriteria = document.getElementById('meddpiccDecisionCriteria').value.trim();
            const decisionProcess = document.getElementById('meddpiccDecisionProcess').value.trim();
            const paperProcess = document.getElementById('meddpiccPaperProcess').value.trim();
            const pain = document.getElementById('meddpiccPain').value.trim();
            const champion = document.getElementById('meddpiccChampion').value.trim();
            const competition = document.getElementById('meddpiccCompetition').value.trim();

            let exportText = `MEETING NOTES\n`;
            exportText += `${'='.repeat(50)}\n\n`;
            exportText += `Customer: ${customerName}\n`;
            exportText += `Title: ${title}\n`;
            exportText += `Date: ${new Date(date).toLocaleString()}\n`;
            exportText += `Type: ${type}\n`;
            if (duration) exportText += `Duration: ${duration} minutes\n`;
            exportText += `\n`;

            if (state.meetingParticipants.length > 0) {
                exportText += `PARTICIPANTS\n${'-'.repeat(50)}\n`;
                state.meetingParticipants.forEach(p => {
                    exportText += ` ${p.name}${p.role ? ` - ${p.role}` : ''}\n`;
                });
                exportText += `\n`;
            }

            if (services) {
                exportText += `SERVICES DISCUSSED\n${'-'.repeat(50)}\n${services}\n\n`;
            }

            exportText += `MEETING NOTES\n${'-'.repeat(50)}\n${notes}\n\n`;

            if (nextSteps) {
                exportText += `NEXT STEPS\n${'-'.repeat(50)}\n${nextSteps}\n\n`;
            }

            // MEDDPICC Section
            const hasMeddpicc = metrics || economicBuyer || decisionCriteria || decisionProcess || 
                               paperProcess || pain || champion || competition;
            
            if (hasMeddpicc) {
                exportText += `MEDDPICC QUALIFICATION\n${'='.repeat(50)}\n\n`;
                
                if (metrics) exportText += ` METRICS\n${metrics}\n\n`;
                if (economicBuyer) exportText += ` ECONOMIC BUYER\n${economicBuyer}\n\n`;
                if (decisionCriteria) exportText += ` DECISION CRITERIA\n${decisionCriteria}\n\n`;
                if (decisionProcess) exportText += ` DECISION PROCESS\n${decisionProcess}\n\n`;
                if (paperProcess) exportText += ` PAPER PROCESS\n${paperProcess}\n\n`;
                if (pain) exportText += ` IDENTIFY PAIN\n${pain}\n\n`;
                if (champion) exportText += ` CHAMPION\n${champion}\n\n`;
                if (competition) exportText += ` COMPETITION\n${competition}\n\n`;
            }

            if (state.meetingTasks.length > 0) {
                exportText += `ACTION ITEMS\n${'-'.repeat(50)}\n`;
                state.meetingTasks.forEach((task, i) => {
                    exportText += `${i + 1}. ${task}\n`;
                });
                exportText += `\n`;
            }

            return exportText;
        }

        function updateMeetingExportPreview() {
            const preview = document.getElementById('meetingExportPreview');
            preview.textContent = generateMeetingExport();
        }

        function copyMeetingToClipboard() {
            const exportText = generateMeetingExport();
            navigator.clipboard.writeText(exportText).then(() => {
                showToast('Meeting notes copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function downloadMeeting() {
            const exportText = generateMeetingExport();
            const customerName = document.getElementById('meetingCustomerInput').value.trim();
            const title = document.getElementById('meetingTitle').value.trim();
            const filename = `meeting_${customerName.replace(/\s+/g, '_')}_${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Meeting notes downloaded!', 'success');
        }

        // Export button for meetings list
        function exportMeetingFromList(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            let exportText = `MEETING NOTES\n`;
            exportText += `${'='.repeat(50)}\n\n`;
            exportText += `Customer: ${meeting.customerName || 'N/A'}\n`;
            exportText += `Title: ${meeting.title}\n`;
            exportText += `Date: ${new Date(meeting.date).toLocaleString()}\n`;
            exportText += `Type: ${meeting.type}\n`;
            if (meeting.duration) exportText += `Duration: ${meeting.duration} minutes\n`;
            exportText += `\n`;

            if (meeting.participants && meeting.participants.length > 0) {
                exportText += `PARTICIPANTS\n${'-'.repeat(50)}\n`;
                meeting.participants.forEach(p => {
                    exportText += ` ${p.name}${p.role ? ` - ${p.role}` : ''}\n`;
                });
                exportText += `\n`;
            }

            if (meeting.services) {
                exportText += `SERVICES DISCUSSED\n${'-'.repeat(50)}\n${meeting.services}\n\n`;
            }

            exportText += `MEETING NOTES\n${'-'.repeat(50)}\n${meeting.notes}\n\n`;

            if (meeting.nextSteps) {
                exportText += `NEXT STEPS\n${'-'.repeat(50)}\n${meeting.nextSteps}\n\n`;
            }

            // MEDDPICC Section
            if (meeting.meddpicc) {
                const m = meeting.meddpicc;
                const hasMeddpicc = m.metrics || m.economicBuyer || m.decisionCriteria || m.decisionProcess || 
                                   m.paperProcess || m.pain || m.champion || m.competition;
                
                if (hasMeddpicc) {
                    exportText += `MEDDPICC QUALIFICATION\n${'='.repeat(50)}\n\n`;
                    
                    if (m.metrics) exportText += ` METRICS\n${m.metrics}\n\n`;
                    if (m.economicBuyer) exportText += ` ECONOMIC BUYER\n${m.economicBuyer}\n\n`;
                    if (m.decisionCriteria) exportText += ` DECISION CRITERIA\n${m.decisionCriteria}\n\n`;
                    if (m.decisionProcess) exportText += ` DECISION PROCESS\n${m.decisionProcess}\n\n`;
                    if (m.paperProcess) exportText += ` PAPER PROCESS\n${m.paperProcess}\n\n`;
                    if (m.pain) exportText += ` IDENTIFY PAIN\n${m.pain}\n\n`;
                    if (m.champion) exportText += ` CHAMPION\n${m.champion}\n\n`;
                    if (m.competition) exportText += ` COMPETITION\n${m.competition}\n\n`;
                }
            }

            const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
            if (meetingTasks.length > 0) {
                exportText += `ACTION ITEMS\n${'-'.repeat(50)}\n`;
                meetingTasks.forEach((task, i) => {
                    exportText += `${i + 1}. ${task.title}\n`;
                });
                exportText += `\n`;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(exportText).then(() => {
                showToast('Meeting notes copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        // Export button for preparation list
        function exportPreparationFromList(preparationId) {
            const preparation = state.preparations.find(p => p.id === preparationId);
            if (!preparation) return;

            let exportText = `MEETING PREPARATION\n`;
            exportText += `${'='.repeat(50)}\n\n`;
            exportText += `Customer: ${preparation.customerName}\n`;
            exportText += `Prepared: ${new Date(preparation.createdAt).toLocaleString()}\n\n`;
            
            if (preparation.goals) {
                exportText += `MEETING GOALS\n${'-'.repeat(50)}\n${preparation.goals}\n\n`;
            }
            
            if (preparation.discussionPoints) {
                exportText += `KEY DISCUSSION POINTS\n${'-'.repeat(50)}\n${preparation.discussionPoints}\n\n`;
            }
            
            if (preparation.background) {
                exportText += `BACKGROUND/CONTEXT\n${'-'.repeat(50)}\n${preparation.background}\n\n`;
            }
            
            if (preparation.materials) {
                exportText += `MATERIALS NEEDED\n${'-'.repeat(50)}\n${preparation.materials}\n\n`;
            }
            
            if (preparation.outcomes) {
                exportText += `EXPECTED OUTCOMES\n${'-'.repeat(50)}\n${preparation.outcomes}\n\n`;
            }

            // Copy to clipboard
            navigator.clipboard.writeText(exportText).then(() => {
                showToast('Preparation copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        // Participants Management
        function addParticipant() {
            const nameInput = document.getElementById('participantNameInput');
            const roleInput = document.getElementById('participantRoleInput');
            
            const name = nameInput.value.trim();
            const role = roleInput.value.trim();
            
            if (!name) {
                showToast('Please enter participant name', 'error');
                return;
            }

            state.meetingParticipants.push({ name, role });
            nameInput.value = '';
            roleInput.value = '';
            renderParticipantsList();
        }

        function removeParticipant(index) {
            state.meetingParticipants.splice(index, 1);
            renderParticipantsList();
        }

        function renderParticipantsList() {
            const container = document.getElementById('participantsList');
            
            if (state.meetingParticipants.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">No participants added yet</div>';
                return;
            }

            container.innerHTML = state.meetingParticipants.map((participant, index) => `
                <div class="participant-item">
                    <div class="participant-info">
                        <div class="participant-name">${escapeHtml(participant.name)}</div>
                        ${participant.role ? `<div class="participant-role">${escapeHtml(participant.role)}</div>` : ''}
                    </div>
                    <button type="button" class="btn-remove-participant" onclick="removeParticipant(${index})"></button>
                </div>
            `).join('');
        }

        // Calculate MEDDPICC completion
        function calculateMEDDPICCCompletion(meeting) {
            const fields = [
                meeting.meddpicc?.metrics,
                meeting.meddpicc?.economicBuyer,
                meeting.meddpicc?.decisionCriteria,
                meeting.meddpicc?.decisionProcess,
                meeting.meddpicc?.paperProcess,
                meeting.meddpicc?.pain,
                meeting.meddpicc?.champion,
                meeting.meddpicc?.competition
            ];
            
            const completed = fields.filter(field => field && field.trim()).length;
            return {
                completed,
                total: 8,
                percentage: Math.round((completed / 8) * 100)
            };
        }

        // Update section title based on current customer
        function updateSectionTitle() {
            const titleElement = document.getElementById('mainSectionTitle');
            if (state.currentCustomer !== 'all') {
                const customer = state.customers.find(c => c.id === state.currentCustomer);
                if (customer) {
                    titleElement.innerHTML = `<span class="section-title-customer"> ${escapeHtml(customer.name)} - Tasks</span>`;
                }
            } else {
                titleElement.textContent = 'Tasks';
            }
        }

        // Show customer preparations section
        function showCustomerPreparationsSection(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;

    const section = document.getElementById('customerPreparationsSection');
    const container = document.getElementById('customerPreparationsList');
    const empty = document.getElementById('customerPreparationsEmpty');

    const customerPreparations = state.preparations.filter(p => p.customerId === customerId);

    if (customerPreparations.length === 0) {
        section.classList.add('empty');
        container.innerHTML = '';
        empty.style.display = 'block';
        empty.className = 'empty-state-compact';
        empty.innerHTML = `
            <div class="empty-state-compact-icon"></div>
            <div>No meeting preparations yet</div>
            <button class="empty-state-add-btn" onclick="openPreparationModalForCustomer('${customerId}')">
                <span>+</span>
                <span>Prepare for Meeting</span>
            </button>
        `;
    } else {
        section.classList.remove('empty');
        empty.style.display = 'none';
        container.innerHTML = customerPreparations.map(preparation => {
            return `
                <div class="customer-preparation-summary">
                    <div class="meeting-summary-header">
                        <div style="flex: 1;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.25rem;">MEETING PREPARATION</div>
                            <div class="meeting-summary-title">
                                 Prepared on ${new Date(preparation.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="task-btn" onclick="exportPreparationFromList('${preparation.id}')" title="Export">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                            <button class="task-btn" onclick="editPreparationFromCustomer('${preparation.id}')" title="Edit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 1rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">MEETING GOALS</div>
                        <div class="meeting-summary-content" id="prep-goals-${preparation.id}">${escapeHtml(preparation.goals)}</div>
                        <button class="meeting-expand-btn" onclick="togglePreparationExpand('prep-goals-${preparation.id}')">Show more</button>
                    </div>

                    ${preparation.discussionPoints ? `
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">DISCUSSION POINTS</div>
                            <div class="meeting-summary-content" id="prep-discussion-${preparation.id}">${escapeHtml(preparation.discussionPoints)}</div>
                            <button class="meeting-expand-btn" onclick="togglePreparationExpand('prep-discussion-${preparation.id}')">Show more</button>
                        </div>
                    ` : ''}

                    ${preparation.background ? `
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">BACKGROUND</div>
                            <div class="meeting-summary-content" id="prep-background-${preparation.id}">${escapeHtml(preparation.background)}</div>
                            <button class="meeting-expand-btn" onclick="togglePreparationExpand('prep-background-${preparation.id}')">Show more</button>
                        </div>
                    ` : ''}

                    ${preparation.materials ? `
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">MATERIALS NEEDED</div>
                            <div class="meeting-summary-content" id="prep-materials-${preparation.id}">${escapeHtml(preparation.materials)}</div>
                            <button class="meeting-expand-btn" onclick="togglePreparationExpand('prep-materials-${preparation.id}')">Show more</button>
                        </div>
                    ` : ''}

                    ${preparation.outcomes ? `
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">EXPECTED OUTCOMES</div>
                            <div class="meeting-summary-content" id="prep-outcomes-${preparation.id}">${escapeHtml(preparation.outcomes)}</div>
                            <button class="meeting-expand-btn" onclick="togglePreparationExpand('prep-outcomes-${preparation.id}')">Show more</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    section.classList.add('active');
}

        function hideCustomerPreparationsSection() {
            document.getElementById('customerPreparationsSection').classList.remove('active');
        }

        function togglePreparationExpand(elementId) {
            const content = document.getElementById(elementId);
            const btn = event.currentTarget;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'Show more';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'Show less';
            }
        }

        function editPreparationFromCustomer(preparationId) {
            const preparation = state.preparations.find(p => p.id === preparationId);
            if (preparation) {
                openPreparationModal(preparation);
            }
        }

        // Show customer meetings section with MEDDPICC
        function showCustomerMeetingsSection(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;

    const section = document.getElementById('customerMeetingsSection');
    const container = document.getElementById('customerMeetingsList');
    const empty = document.getElementById('customerMeetingsEmpty');

    const customerMeetings = state.meetings.filter(m => m.customerId === customerId);
    if (customerMeetings.length === 0) {
        section.classList.add('empty');
        container.innerHTML = '';
        empty.style.display = 'block';
        empty.className = 'empty-state-compact';
        empty.innerHTML = `
            <div class="empty-state-compact-icon"></div>
            <div>No meetings yet</div>
            <button class="empty-state-add-btn" onclick="openMeetingModalForCustomer('${customerId}')">
                <span>+</span>
                <span>Add Meeting Notes</span>
            </button>
        `;
    } else {
        section.classList.remove('empty');
        empty.style.display = 'none';
        container.innerHTML = customerMeetings.map(meeting => {
            const meetingDate = new Date(meeting.date);
            const outcomeEmoji = {
                'positive': '',
                'neutral': '',
                'negative': '',
                'pending': '',
                'won': '',
                'lost': ''
            };

            const meddpiccScore = calculateMEDDPICCCompletion(meeting);
            const hasPreparation = state.preparations.some(p => p.customerId === customerId);
            
            return `
                <div class="customer-meeting-summary">
                    <div class="meeting-summary-header">
                        <div style="flex: 1;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.25rem;">MEETING TITLE</div>
                            <div class="meeting-summary-title">
                                ${escapeHtml(meeting.title)} ${meeting.outcome ? outcomeEmoji[meeting.outcome] || '' : ''}
                                ${hasPreparation ? '<span class="preparation-badge"> Prepared</span>' : ''}
                            </div>
                            <div class="meeting-summary-date">
                                 ${meetingDate.toLocaleDateString()} at ${meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                ${meeting.type ? `   ${escapeHtml(meeting.type)}` : ''}
                                ${meeting.duration ? `   ${meeting.duration}min` : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="task-btn" onclick="exportMeetingFromList('${meeting.id}')" title="Export">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                            <button class="task-btn" onclick="editMeetingFromCustomer('${meeting.id}')" title="Edit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    ${meeting.participants && meeting.participants.length > 0 ? `
                        <div style="margin-top: 1rem; margin-bottom: 0.75rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">PARTICIPANTS</div>
                            ${meeting.participants.map(p => `
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.85rem; margin-right: 0.5rem; margin-bottom: 0.5rem;">
                                     ${escapeHtml(p.name)}${p.role ? ` - ${escapeHtml(p.role)}` : ''}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${meddpiccScore.completed > 0 ? `
                        <div class="meddpicc-progress">
                            <div class="meddpicc-progress-header">
                                <div class="meddpicc-progress-title"> MEDDPICC Qualification</div>
                                <div class="meddpicc-progress-score">${meddpiccScore.completed}/${meddpiccScore.total}</div>
                            </div>
                            <div class="meddpicc-progress-bar">
                                <div class="meddpicc-progress-fill" style="width: ${meddpiccScore.percentage}%"></div>
                            </div>
                            <div class="meddpicc-items">
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.metrics ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.metrics ? '' : ''}
                                    </div>
                                    <span>Metrics</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.economicBuyer ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.economicBuyer ? '' : ''}
                                    </div>
                                    <span>Econ Buyer</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.decisionCriteria ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.decisionCriteria ? '' : ''}
                                    </div>
                                    <span>Criteria</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.decisionProcess ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.decisionProcess ? '' : ''}
                                    </div>
                                    <span>Process</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.paperProcess ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.paperProcess ? '' : ''}
                                    </div>
                                    <span>Paper</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.pain ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.pain ? '' : ''}
                                    </div>
                                    <span>Pain</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.champion ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.champion ? '' : ''}
                                    </div>
                                    <span>Champion</span>
                                </div>
                                <div class="meddpicc-item">
                                    <div class="meddpicc-item-icon ${meeting.meddpicc?.competition ? 'completed' : 'incomplete'}">
                                        ${meeting.meddpicc?.competition ? '' : ''}
                                    </div>
                                    <span>Competition</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${meeting.tags && meeting.tags.length > 0 ? `
                        <div style="margin-top: 1rem; margin-bottom: 0.75rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">TAGS</div>
                            ${meeting.tags.map(tag => `<span class="meeting-tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    ${meeting.services ? `
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">SERVICES DISCUSSED</div>
                            <div style="color: var(--text-secondary); font-size: 0.95rem; white-space: pre-wrap;">${escapeHtml(meeting.services)}</div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">MEETING NOTES</div>
                        <div class="meeting-summary-content" id="meeting-content-${meeting.id}">${escapeHtml(meeting.notes)}</div>
                        <button class="meeting-expand-btn" onclick="toggleMeetingExpand('${meeting.id}')">Show more</button>
                    </div>
                    
                    ${meeting.nextSteps ? `
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">NEXT STEPS</div>
                            <div style="color: var(--text-secondary); font-size: 0.95rem; white-space: pre-wrap;">${escapeHtml(meeting.nextSteps)}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    section.classList.add('active');
}

        function hideCustomerMeetingsSection() {
            document.getElementById('customerMeetingsSection').classList.remove('active');
        }

        function toggleMeetingExpand(meetingId) {
            const content = document.getElementById(`meeting-content-${meetingId}`);
            const btn = event.currentTarget;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'Show more';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'Show less';
            }
        }

        function editMeetingFromCustomer(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (meeting) {
                openMeetingModal(meeting);
            }
        }

        // Color Picker
        function setupColorPicker() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    state.selectedColor = option.dataset.color;
                    document.getElementById('taskColor').value = state.selectedColor;
                });
            });
        }

        // Customer Combobox for Meeting Modal
        function setupCustomerCombobox() {
            const input = document.getElementById('meetingCustomerInput');
            const dropdown = document.getElementById('customerDropdown');

            input.addEventListener('focus', () => {
                updateCustomerDropdown();
                dropdown.classList.add('active');
            });

            input.addEventListener('input', () => {
                updateCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.customer-combobox')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        // Customer Combobox for Task Modal
        function setupTaskCustomerCombobox() {
            const input = document.getElementById('taskCustomerInput');
            const dropdown = document.getElementById('taskCustomerDropdown');

            input.addEventListener('focus', () => {
                updateTaskCustomerDropdown();
                dropdown.classList.add('active');
            });

            input.addEventListener('input', () => {
                updateTaskCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#taskCustomerInput') && !e.target.closest('#taskCustomerDropdown')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        // Customer Combobox for Preparation Modal
        function setupPreparationCustomerCombobox() {
            const input = document.getElementById('preparationCustomerInput');
            const dropdown = document.getElementById('preparationCustomerDropdown');

            input.addEventListener('focus', () => {
                updatePreparationCustomerDropdown();
                dropdown.classList.add('active');
            });

            input.addEventListener('input', () => {
                updatePreparationCustomerDropdown(input.value);
                dropdown.classList.add('active');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#preparationCustomerInput') && !e.target.closest('#preparationCustomerDropdown')) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function updateCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('customerDropdown');
            const filteredCustomers = state.customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            let html = '';

            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `
                    <div class="customer-dropdown-item new-customer" onclick="selectNewCustomer('${escapeHtml(searchTerm)}')">
                         Add "${escapeHtml(searchTerm)}" as new customer
                    </div>
                `;
            }

            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });

            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary);">No customers yet. Start typing to add one.</div>';
            }

            dropdown.innerHTML = html;
        }

        function updateTaskCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('taskCustomerDropdown');
            const filteredCustomers = state.customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            let html = '';

            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `
                    <div class="customer-dropdown-item new-customer" onclick="selectNewTaskCustomer('${escapeHtml(searchTerm)}')">
                         Add "${escapeHtml(searchTerm)}" as new customer
                    </div>
                `;
            }

            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingTaskCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });

            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary);">No customers yet. Start typing to add one.</div>';
            }

            dropdown.innerHTML = html;
        }

        function updatePreparationCustomerDropdown(searchTerm = '') {
            const dropdown = document.getElementById('preparationCustomerDropdown');
            const filteredCustomers = state.customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            let html = '';

            if (searchTerm && !filteredCustomers.some(c => c.name.toLowerCase() === searchTerm.toLowerCase())) {
                html += `
                    <div class="customer-dropdown-item new-customer" onclick="selectNewPreparationCustomer('${escapeHtml(searchTerm)}')">
                         Add "${escapeHtml(searchTerm)}" as new customer
                    </div>
                `;
            }

            filteredCustomers.forEach(customer => {
                html += `
                    <div class="customer-dropdown-item" onclick="selectExistingPreparationCustomer('${customer.id}')">
                        <div class="customer-dropdown-item-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-dropdown-item-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                `;
            });

            if (filteredCustomers.length === 0 && !searchTerm) {
                html = '<div class="customer-dropdown-item" style="text-align: center; color: var(--text-secondary);">No customers yet. Start typing to add one.</div>';
            }

            dropdown.innerHTML = html;
        }

        function selectExistingCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('meetingCustomerInput').value = customer.name;
                state.selectedCustomerId = customerId;
                document.getElementById('customerDropdown').classList.remove('active');
                
                // Check if preparation exists for this customer and load it
                loadPreparationForCustomer(customerId);
            }
        }

        function selectNewCustomer(customerName) {
            document.getElementById('meetingCustomerInput').value = customerName;
            state.selectedCustomerId = null;
            document.getElementById('customerDropdown').classList.remove('active');
            
            // Hide preparation tab for new customers
            document.getElementById('preparationTab').style.display = 'none';
        }

        function selectExistingTaskCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('taskCustomerInput').value = customer.name;
                state.selectedTaskCustomerId = customerId;
                document.getElementById('taskCustomerDropdown').classList.remove('active');
            }
        }

        function selectNewTaskCustomer(customerName) {
            document.getElementById('taskCustomerInput').value = customerName;
            state.selectedTaskCustomerId = null;
            document.getElementById('taskCustomerDropdown').classList.remove('active');
        }

        function selectExistingPreparationCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('preparationCustomerInput').value = customer.name;
                state.selectedPreparationCustomerId = customerId;
                document.getElementById('preparationCustomerDropdown').classList.remove('active');
            }
        }

        function selectNewPreparationCustomer(customerName) {
            document.getElementById('preparationCustomerInput').value = customerName;
            state.selectedPreparationCustomerId = null;
            document.getElementById('preparationCustomerDropdown').classList.remove('active');
        }

        // Load preparation for customer in meeting modal
        function loadPreparationForCustomer(customerId) {
            const preparation = state.preparations.find(p => p.customerId === customerId);
            const preparationTab = document.getElementById('preparationTab');
            const preparationContent = document.getElementById('preparationContent');
            
            if (preparation) {
                preparationTab.style.display = 'flex';
                preparationContent.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color: white; font-weight: 600;">
                         Meeting Preparation Available
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem;">MEETING GOALS</div>
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(preparation.goals)}</div>
                    </div>
                    
                    ${preparation.discussionPoints ? `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem;">DISCUSSION POINTS</div>
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(preparation.discussionPoints)}</div>
                        </div>
                    ` : ''}
                    
                    ${preparation.background ? `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem;">BACKGROUND/CONTEXT</div>
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(preparation.background)}</div>
                        </div>
                    ` : ''}
                    
                    ${preparation.materials ? `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem;">MATERIALS NEEDED</div>
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(preparation.materials)}</div>
                        </div>
                    ` : ''}
                    
                    ${preparation.outcomes ? `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem;">EXPECTED OUTCOMES</div>
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(preparation.outcomes)}</div>
                        </div>
                    ` : ''}
                    
                    <button type="button" class="btn btn-secondary" onclick="editPreparationFromMeeting('${preparation.id}')" style="width: 100%;"> Edit Preparation</button>
                `;
            } else {
                preparationTab.style.display = 'none';
                preparationContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No preparation found for this customer</p>';
            }
        }

        function editPreparationFromMeeting(preparationId) {
            const preparation = state.preparations.find(p => p.id === preparationId);
            if (preparation) {
                closeMeetingModal();
                openPreparationModal(preparation);
            }
        }

        // Tags Overview Modal
        function openTagsOverviewModal() {
            renderTagsOverview();
            document.getElementById('tagsOverviewModal').classList.add('active');
        }

        function closeTagsOverviewModal() {
            document.getElementById('tagsOverviewModal').classList.remove('active');
            state.selectedTag = null;
        }

        function renderTagsOverview() {
            const tagsMap = new Map();
            
            // Collect all tags from meetings
            state.meetings.forEach(meeting => {
                if (meeting.tags && meeting.tags.length > 0) {
                    meeting.tags.forEach(tag => {
                        if (!tagsMap.has(tag)) {
                            tagsMap.set(tag, []);
                        }
                        tagsMap.get(tag).push({
                            meetingId: meeting.id,
                            customerId: meeting.customerId,
                            customerName: meeting.customerName,
                            meetingTitle: meeting.title,
                            meetingDate: meeting.date
                        });
                    });
                }
            });

            const tagsContainer = document.getElementById('tagsListContainer');
            const emptyState = document.getElementById('tagsEmpty');

            if (tagsMap.size === 0) {
                tagsContainer.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('selectedTagTitle').textContent = 'No tags available';
                document.getElementById('customersByTagContainer').innerHTML = '';
                return;
            }

            emptyState.style.display = 'none';

            // Convert to array and sort by count
            const sortedTags = Array.from(tagsMap.entries()).sort((a, b) => b[1].length - a[1].length);

            tagsContainer.innerHTML = sortedTags.map(([tag, meetings]) => `
                <div class="tag-item" onclick="selectTag('${escapeHtml(tag)}')">
                    <span class="tag-item-name"> ${escapeHtml(tag)}</span>
                    <span class="tag-item-count">${meetings.length}</span>
                </div>
            `).join('');

            // Select first tag by default if none selected
            if (!state.selectedTag && sortedTags.length > 0) {
                selectTag(sortedTags[0][0]);
            } else if (state.selectedTag) {
                selectTag(state.selectedTag);
            }
        }

        function selectTag(tag) {
            state.selectedTag = tag;
            
            // Update active state
            document.querySelectorAll('.tag-item').forEach(item => item.classList.remove('active'));
            event.currentTarget?.classList.add('active');

            // Update title
            document.getElementById('selectedTagTitle').textContent = `Customers with tag: ${tag}`;

            // Get all meetings with this tag
            const meetingsWithTag = state.meetings.filter(m => 
                m.tags && m.tags.includes(tag)
            );

            // Group by customer
            const customerMeetings = new Map();
            meetingsWithTag.forEach(meeting => {
                if (meeting.customerId) {
                    if (!customerMeetings.has(meeting.customerId)) {
                        customerMeetings.set(meeting.customerId, {
                            customerName: meeting.customerName,
                            meetings: []
                        });
                    }
                    customerMeetings.get(meeting.customerId).meetings.push(meeting);
                }
            });

            const container = document.getElementById('customersByTagContainer');

            if (customerMeetings.size === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 2rem;"><div class="empty-state-icon"></div><div>No customers found with this tag</div></div>';
                return;
            }

            container.innerHTML = Array.from(customerMeetings.entries()).map(([customerId, data]) => `
                <div class="customer-tag-card">
                    <div class="customer-tag-header">
                        <div class="customer-tag-name"> ${escapeHtml(data.customerName)}</div>
                        <div class="meetings-count-badge">${data.meetings.length} meeting${data.meetings.length > 1 ? 's' : ''}</div>
                    </div>
                    <div class="meetings-list-compact">
                        ${data.meetings.map(meeting => `
                            <div class="meeting-compact-item">
                                <strong>${escapeHtml(meeting.title)}</strong>
                                <div class="meeting-compact-date">
                                     ${new Date(meeting.date).toLocaleDateString()} at ${new Date(meeting.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Customer Management
        function openCustomersModal() {
            renderCustomerList();
            document.getElementById('customersModal').classList.add('active');
        }

        function closeCustomersModal() {
            document.getElementById('customersModal').classList.remove('active');
        }

        function openAddCustomerForm() {
            state.editingCustomer = null;
            document.getElementById('customerFormTitle').textContent = 'Add Customer';
            document.getElementById('customerForm').reset();
            document.getElementById('customerFormModal').classList.add('active');
        }

        function openEditCustomerForm(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (!customer) return;

            state.editingCustomer = customer;
            document.getElementById('customerFormTitle').textContent = 'Edit Customer';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerCompany').value = customer.company || '';
            document.getElementById('customerNotes').value = customer.notes || '';
            
            document.getElementById('customerFormModal').classList.add('active');
        }

        function closeCustomerFormModal() {
            document.getElementById('customerFormModal').classList.remove('active');
            state.editingCustomer = null;
        }

        function handleCustomerSubmit(e) {
            e.preventDefault();

            const customer = {
                id: document.getElementById('customerId').value || Date.now().toString(),
                name: document.getElementById('customerName').value.trim(),
                email: document.getElementById('customerEmail').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                company: document.getElementById('customerCompany').value.trim(),
                notes: document.getElementById('customerNotes').value.trim(),
                createdAt: state.editingCustomer?.createdAt || new Date().toISOString()
            };

            if (state.editingCustomer) {
                const index = state.customers.findIndex(c => c.id === customer.id);
                state.customers[index] = customer;
                showToast('Customer updated!', 'success');
            } else {
                state.customers.push(customer);
                showToast('Customer added!', 'success');
            }

            saveData();
            renderCustomerList();
            renderCustomerFilters();
            closeCustomerFormModal();
        }

        function deleteCustomer(customerId) {
            showConfirm(
                '',
                'Delete Customer?',
                'This will not delete associated tasks, meetings, and preparations, but will remove the customer reference.',
                () => {
                    state.customers = state.customers.filter(c => c.id !== customerId);
                    saveData();
                    renderCustomerList();
                    renderCustomerFilters();
                    showToast('Customer deleted', 'success');
                }
            );
        }

        function renderCustomerList() {
            const container = document.getElementById('customerList');
            const empty = document.getElementById('customersEmpty');

            if (state.customers.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            container.innerHTML = state.customers.map(customer => `
                <div class="customer-item">
                    <div class="customer-info">
                        <div class="customer-name">${escapeHtml(customer.name)}</div>
                        ${customer.email ? `<div class="customer-email">${escapeHtml(customer.email)}</div>` : ''}
                    </div>
                    <div class="customer-actions">
                        <button class="task-btn" onclick="openEditCustomerForm('${customer.id}')" title="Edit">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="task-btn delete" onclick="deleteCustomer('${customer.id}')" title="Delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderCustomerFilters() {
            const container = document.getElementById('customerFilters');
            
            const taskCounts = {};
            state.tasks.filter(t => !t.archived).forEach(task => {
                if (task.customerId) {
                    taskCounts[task.customerId] = (taskCounts[task.customerId] || 0) + 1;
                }
            });

            container.innerHTML = state.customers.map(customer => `
                <button class="category-filter" data-customer="${customer.id}">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span class="category-dot" style="background: #667eea"></span>
                        ${escapeHtml(customer.name)}
                    </div>
                    <span class="customer-count">${taskCounts[customer.id] || 0}</span>
                </button>
            `).join('');

            const allCount = state.tasks.filter(t => !t.archived).length;
            document.getElementById('allCustomersCount').textContent = allCount;

            document.querySelectorAll('.category-filter[data-customer]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.customer === 'all') return;
                    
                    document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentCustomer = btn.dataset.customer;
                    
                    hideCustomerOverview();
                    showCustomerPreparationsSection(state.currentCustomer);
                    showCustomerMeetingsSection(state.currentCustomer);
                    updateSectionTitle();
                    renderTasks();
                });
            });
        }

// Open preparation modal with customer pre-selected
function openPreparationModalForCustomer(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    state.editingPreparation = null;
    state.selectedPreparationCustomerId = customerId;

    // Reset to first tab
    document.querySelectorAll('#preparationModal .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#preparationModal .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#preparationModal .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#preparationModal [data-tab-content="info"]').classList.add('active');
    state.currentPreparationTab = 'info';

    document.getElementById('preparationForm').reset();
    document.getElementById('preparationCustomerInput').value = customer.name;

    document.getElementById('preparationModal').classList.add('active');
}

// Open meeting modal with customer pre-selected
function openMeetingModalForCustomer(customerId) {
    const customer = state.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    state.editingMeeting = null;
    state.meetingTasks = [];
    state.meetingParticipants = [];
    state.selectedCustomerId = customerId;

    // Reset to first tab
    document.querySelectorAll('#meetingModal .modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#meetingModal .tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('#meetingModal .modal-tab[data-tab="info"]').classList.add('active');
    document.querySelector('#meetingModal [data-tab-content="info"]').classList.add('active');
    state.currentMeetingTab = 'info';

    document.getElementById('meetingForm').reset();
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
    document.getElementById('meetingCustomerInput').value = customer.name;
    
    state.meetingTasks = [];
    state.meetingParticipants = [];
    renderMeetingTasksList();
    renderParticipantsList();
    
    // Load preparation if exists
    loadPreparationForCustomer(customerId);

    document.getElementById('meetingModal').classList.add('active');
}

        // Preparation Management
        function openPreparationModal(preparation = null) {
            state.editingPreparation = preparation;
            state.selectedPreparationCustomerId = null;

            // Reset to first tab
            document.querySelectorAll('#preparationModal .modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#preparationModal .tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('#preparationModal .modal-tab[data-tab="info"]').classList.add('active');
            document.querySelector('#preparationModal [data-tab-content="info"]').classList.add('active');
            state.currentPreparationTab = 'info';

            if (preparation) {
                document.getElementById('preparationId').value = preparation.id;
                document.getElementById('preparationCustomerInput').value = preparation.customerName || '';
                state.selectedPreparationCustomerId = preparation.customerId;
                document.getElementById('preparationGoals').value = preparation.goals;
                document.getElementById('preparationDiscussionPoints').value = preparation.discussionPoints || '';
                document.getElementById('preparationBackground').value = preparation.background || '';
                document.getElementById('preparationMaterials').value = preparation.materials || '';
                document.getElementById('preparationOutcomes').value = preparation.outcomes || '';
            } else {
                document.getElementById('preparationForm').reset();
                document.getElementById('preparationCustomerInput').value = '';
            }

            document.getElementById('preparationModal').classList.add('active');
        }

        function closePreparationModal() {
            document.getElementById('preparationModal').classList.remove('active');
            state.editingPreparation = null;
            state.selectedPreparationCustomerId = null;
        }

        function handlePreparationSubmit(e) {
            e.preventDefault();

            const customerInputValue = document.getElementById('preparationCustomerInput').value.trim();
            let customerId = state.selectedPreparationCustomerId;
            let customerName = customerInputValue;

            if (!customerId && customerInputValue) {
                const newCustomer = {
                    id: Date.now().toString(),
                    name: customerInputValue,
                    email: '',
                    phone: '',
                    company: '',
                    notes: '',
                    createdAt: new Date().toISOString()
                };
                state.customers.push(newCustomer);
                customerId = newCustomer.id;
                customerName = newCustomer.name;
                showToast('New customer created!', 'success');
            }

            const preparation = {
                id: document.getElementById('preparationId').value || Date.now().toString(),
                customerId: customerId,
                customerName: customerName,
                goals: document.getElementById('preparationGoals').value.trim(),
                discussionPoints: document.getElementById('preparationDiscussionPoints').value.trim(),
                background: document.getElementById('preparationBackground').value.trim(),
                materials: document.getElementById('preparationMaterials').value.trim(),
                outcomes: document.getElementById('preparationOutcomes').value.trim(),
                createdAt: state.editingPreparation?.createdAt || new Date().toISOString()
            };

            if (state.editingPreparation) {
                const index = state.preparations.findIndex(p => p.id === preparation.id);
                state.preparations[index] = preparation;
                showToast('Preparation updated!', 'success');
            } else {
                // Check if preparation already exists for this customer
                const existingIndex = state.preparations.findIndex(p => p.customerId === customerId);
                if (existingIndex !== -1) {
                    state.preparations[existingIndex] = preparation;
                    showToast('Preparation updated!', 'success');
                } else {
                    state.preparations.unshift(preparation);
                    showToast('Preparation saved!', 'success');
                }
            }

            saveData();
            renderCustomerFilters();
            
            // Refresh customer overview if active
            if (document.getElementById('customerOverviewSection').classList.contains('active')) {
                renderCustomerOverview();
            }
            
            closePreparationModal();
        }

        // Meeting Management with MEDDPICC
        function openMeetingModal(meeting = null) {
            state.editingMeeting = meeting;
            state.meetingTasks = [];
            state.meetingParticipants = [];
            state.selectedCustomerId = null;

            // Reset to first tab
            document.querySelectorAll('#meetingModal .modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#meetingModal .tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('#meetingModal .modal-tab[data-tab="info"]').classList.add('active');
            document.querySelector('#meetingModal [data-tab-content="info"]').classList.add('active');
            state.currentMeetingTab = 'info';

            if (meeting) {
                document.getElementById('meetingId').value = meeting.id;
                document.getElementById('meetingCustomerInput').value = meeting.customerName || '';
                state.selectedCustomerId = meeting.customerId;
                document.getElementById('meetingDate').value = meeting.date;
                document.getElementById('meetingType').value = meeting.type || 'other';
                document.getElementById('meetingDuration').value = meeting.duration || '';
                document.getElementById('meetingTitle').value = meeting.title;
                document.getElementById('meetingTags').value = meeting.tags ? meeting.tags.join(', ') : '';
                document.getElementById('meetingServices').value = meeting.services || '';
                document.getElementById('meetingNotes').value = meeting.notes;
                document.getElementById('meetingNextSteps').value = meeting.nextSteps || '';
                document.getElementById('meetingFollowUpDate').value = meeting.followUpDate || '';
                document.getElementById('meetingOutcome').value = meeting.outcome || '';
                
                // Load participants
                state.meetingParticipants = meeting.participants || [];
                renderParticipantsList();
                
                // Load MEDDPICC data
                document.getElementById('meddpiccMetrics').value = meeting.meddpicc?.metrics || '';
                document.getElementById('meddpiccEconomicBuyer').value = meeting.meddpicc?.economicBuyer || '';
                document.getElementById('meddpiccDecisionCriteria').value = meeting.meddpicc?.decisionCriteria || '';
                document.getElementById('meddpiccDecisionProcess').value = meeting.meddpicc?.decisionProcess || '';
                document.getElementById('meddpiccPaperProcess').value = meeting.meddpicc?.paperProcess || '';
                document.getElementById('meddpiccPain').value = meeting.meddpicc?.pain || '';
                document.getElementById('meddpiccChampion').value = meeting.meddpicc?.champion || '';
                document.getElementById('meddpiccCompetition').value = meeting.meddpicc?.competition || '';
                
                const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
                state.meetingTasks = meetingTasks.map(t => t.title);
                renderMeetingTasksList();
                
                // Load preparation if exists
                if (meeting.customerId) {
                    loadPreparationForCustomer(meeting.customerId);
                }
            } else {
                document.getElementById('meetingForm').reset();
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
                state.meetingTasks = [];
                state.meetingParticipants = [];
                renderMeetingTasksList();
                renderParticipantsList();
                document.getElementById('preparationTab').style.display = 'none';
            }

            document.getElementById('meetingModal').classList.add('active');
        }

        function closeMeetingModal() {
            document.getElementById('meetingModal').classList.remove('active');
            state.editingMeeting = null;
            state.meetingTasks = [];
            state.meetingParticipants = [];
            state.selectedCustomerId = null;
        }

        function addQuickTask() {
            const input = document.getElementById('quickTaskInput');
            const taskTitle = input.value.trim();
            
            if (!taskTitle) {
                showToast('Please enter a task title', 'error');
                return;
            }

            state.meetingTasks.push(taskTitle);
            input.value = '';
            renderMeetingTasksList();
        }

        function removeMeetingTask(index) {
            state.meetingTasks.splice(index, 1);
            renderMeetingTasksList();
        }

        function renderMeetingTasksList() {
            const container = document.getElementById('meetingTasksList');
            
            if (state.meetingTasks.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">No action items added yet</div>';
                return;
            }

            container.innerHTML = state.meetingTasks.map((task, index) => `
                <div class="meeting-task-preview">
                    <span> ${escapeHtml(task)}</span>
                    <button type="button" class="btn-remove-meeting-task" onclick="removeMeetingTask(${index})"></button>
                </div>
            `).join('');
        }

        function handleMeetingSubmit(e) {
            e.preventDefault();

            const customerInputValue = document.getElementById('meetingCustomerInput').value.trim();
            let customerId = state.selectedCustomerId;
            let customerName = customerInputValue;

            if (!customerId && customerInputValue) {
                const newCustomer = {
                    id: Date.now().toString(),
                    name: customerInputValue,
                    email: '',
                    phone: '',
                    company: '',
                    notes: '',
                    createdAt: new Date().toISOString()
                };
                state.customers.push(newCustomer);
                customerId = newCustomer.id;
                customerName = newCustomer.name;
                showToast('New customer created!', 'success');
            }

            const tagsInput = document.getElementById('meetingTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            const meeting = {
                id: document.getElementById('meetingId').value || Date.now().toString(),
                customerId: customerId,
                customerName: customerName,
                date: document.getElementById('meetingDate').value,
                type: document.getElementById('meetingType').value,
                duration: document.getElementById('meetingDuration').value,
                title: document.getElementById('meetingTitle').value.trim(),
                tags: tags,
                participants: state.meetingParticipants,
                services: document.getElementById('meetingServices').value.trim(),
                notes: document.getElementById('meetingNotes').value.trim(),
                nextSteps: document.getElementById('meetingNextSteps').value.trim(),
                followUpDate: document.getElementById('meetingFollowUpDate').value,
                outcome: document.getElementById('meetingOutcome').value,
                meddpicc: {
                    metrics: document.getElementById('meddpiccMetrics').value.trim(),
                    economicBuyer: document.getElementById('meddpiccEconomicBuyer').value.trim(),
                    decisionCriteria: document.getElementById('meddpiccDecisionCriteria').value.trim(),
                    decisionProcess: document.getElementById('meddpiccDecisionProcess').value.trim(),
                    paperProcess: document.getElementById('meddpiccPaperProcess').value.trim(),
                    pain: document.getElementById('meddpiccPain').value.trim(),
                    champion: document.getElementById('meddpiccChampion').value.trim(),
                    competition: document.getElementById('meddpiccCompetition').value.trim()
                },
                createdAt: state.editingMeeting?.createdAt || new Date().toISOString()
            };

            if (state.editingMeeting) {
                const index = state.meetings.findIndex(m => m.id === meeting.id);
                state.meetings[index] = meeting;
                showToast('Meeting updated!', 'success');
            } else {
                state.meetings.unshift(meeting);
                showToast('Meeting saved!', 'success');
            }

            state.meetingTasks.forEach(taskTitle => {
                const existingTask = state.tasks.find(t => t.meetingId === meeting.id && t.title === taskTitle);
                if (!existingTask) {
                    const task = {
                        id: Date.now().toString() + Math.random(),
                        title: taskTitle,
                        description: `From meeting: ${meeting.title}`,
                        priority: 'medium',
                        status: 'todo',
                        dueDate: '',
                        tags: ['meeting'],
                        color: 'none',
                        subtasks: [],
                        completed: false,
                        archived: false,
                        customerId: customerId,
                        customerName: customerName,
                        meetingId: meeting.id,
                        createdAt: new Date().toISOString()
                    };
                    state.tasks.unshift(task);
                }
            });

            saveData();
            renderTasks();
            updateStats();
            renderCustomerFilters();
            
            // Refresh customer overview if active
            if (document.getElementById('customerOverviewSection').classList.contains('active')) {
                renderCustomerOverview();
            }
            
            if (state.currentCustomer !== 'all' && state.currentCustomer === customerId) {
                showCustomerMeetingsSection(customerId);
            }
            
            closeMeetingModal();
        }

        function openAllMeetingsModal() {
            renderAllMeetings();
            document.getElementById('allMeetingsModal').classList.add('active');
        }

        function closeAllMeetingsModal() {
            document.getElementById('allMeetingsModal').classList.remove('active');
        }

        function renderAllMeetings() {
            const container = document.getElementById('allMeetingsList');
            const empty = document.getElementById('meetingsEmpty');

            if (state.meetings.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            container.innerHTML = state.meetings.map(meeting => {
                const meetingTasks = state.tasks.filter(t => t.meetingId === meeting.id);
                const meetingDate = new Date(meeting.date);
                
                const outcomeEmoji = {
                    'positive': '',
                    'neutral': '',
                    'negative': '',
                    'pending': '',
                    'won': '',
                    'lost': ''
                };

                const meddpiccScore = calculateMEDDPICCCompletion(meeting);
                const hasPreparation = state.preparations.some(p => p.customerId === meeting.customerId);
                
                return `
                    <div class="meeting-card">
                        <div class="meeting-header">
                            <div class="meeting-info">
                                <h3>
                                    ${escapeHtml(meeting.title)} ${meeting.outcome ? outcomeEmoji[meeting.outcome] || '' : ''}
                                    ${hasPreparation ? '<span class="preparation-badge"> Prepared</span>' : ''}
                                </h3>
                                <div class="meeting-date">
                                     ${meetingDate.toLocaleDateString()} at ${meetingDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    ${meeting.customerName ? `   ${escapeHtml(meeting.customerName)}` : ''}
                                    ${meeting.type ? `   ${escapeHtml(meeting.type)}` : ''}
                                    ${meeting.duration ? `   ${meeting.duration}min` : ''}
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="task-btn" onclick="exportMeetingFromList('${meeting.id}')" title="Export">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                                <button class="task-btn" onclick="editMeeting('${meeting.id}')" title="Edit">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="task-btn delete" onclick="deleteMeeting('${meeting.id}')" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        ${meeting.participants && meeting.participants.length > 0 ? `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <strong style="display: block; margin-bottom: 0.5rem;">Participants:</strong>
                                ${meeting.participants.map(p => `
                                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--bg-secondary); border-radius: 8px; font-size: 0.85rem; margin-right: 0.5rem; margin-bottom: 0.5rem;">
                                         ${escapeHtml(p.name)}${p.role ? ` - ${escapeHtml(p.role)}` : ''}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${meddpiccScore.completed > 0 ? `
                            <div class="meddpicc-section">
                                <div class="meddpicc-section-title">
                                     MEDDPICC Qualification (${meddpiccScore.completed}/${meddpiccScore.total})
                                </div>
                                <div class="meddpicc-grid">
                                    ${meeting.meddpicc?.metrics ? `
                                        <div class="meddpicc-field">
                                            <div class="meddpicc-field-label"> Metrics</div>
                                            <div class="meddpicc-field-value">${escapeHtml(meeting.meddpicc.metrics)}</div>
                                        </div>
                                    ` : ''}
                                    ${meeting.meddpicc?.economicBuyer ? `
                                        <div class="meddpicc-field">
                                            <div class="meddpicc-field-label"> Economic Buyer</div>
                                            <div class="meddpicc-field-value">${escapeHtml(meeting.meddpicc.economicBuyer)}</div>
                                        </div>
                                    ` : ''}
                                    ${meeting.meddpicc?.decisionCriteria ? `
                                        <div class="meddpicc-field">
                                            <div class="meddpicc-field-label"> Decision Criteria</div>
                                            <div class="meddpicc-field-value">${escapeHtml(meeting.meddpicc.decisionCriteria)}</div>
                                        </div>
                                    ` : ''}
                                    ${meeting.meddpicc?.decisionProcess ? `
                                        <div class="meddpicc-field">
                                            <div class="meddpicc-field-label"> Decision Process</div>
                                            <div class="meddpicc-field-value">${escapeHtml(meeting.meddpicc.decisionProcess)}</div>
                                        </div>
                                    ` : ''}
                                    ${meeting.meddpicc?.paperProcess ? `
                                        <div class="meddpicc-field">
                                            <div class="meddpicc-field-label"> Paper Process</div>
                                            <div class="meddpicc-field-value">${escapeHtml(meeting.meddpicc.paperProcess)}</div>
                                        </div>
                                    ` : ''}
                                    ${meeting.meddpicc?.pain ? `
                                        <div class="meddpicc-field">
                                            <div class="meddpicc-field-label"> Identify Pain</div>
                                            <div class="meddpicc-field-value">${escapeHtml(meeting.meddpicc.pain)}</div>
                                        </div>
                                    ` : ''}
                                    ${meeting.meddpicc?.champion ? `
                                        <div class="meddpicc-field">
                                            <div class="meddpicc-field-label"> Champion</div>
                                            <div class="meddpicc-field-value">${escapeHtml(meeting.meddpicc.champion)}</div>
                                        </div>
                                    ` : ''}
                                    ${meeting.meddpicc?.competition ? `
                                        <div class="meddpicc-field">
                                            <div class="meddpicc-field-label"> Competition</div>
                                            <div class="meddpicc-field-value">${escapeHtml(meeting.meddpicc.competition)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${meeting.tags && meeting.tags.length > 0 ? `
                            <div class="meeting-tags-container">
                                ${meeting.tags.map(tag => `<span class="meeting-tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${meeting.services ? `
                            <div style="margin-bottom: 1rem;">
                                <strong>Services Discussed:</strong>
                                <div class="meeting-notes" style="margin-top: 0.5rem;">${escapeHtml(meeting.services)}</div>
                            </div>
                        ` : ''}
                        <div class="meeting-notes">${escapeHtml(meeting.notes)}</div>
                        ${meeting.nextSteps ? `
                            <div style="margin-top: 1rem;">
                                <strong>Next Steps:</strong>
                                <div class="meeting-notes" style="margin-top: 0.5rem;">${escapeHtml(meeting.nextSteps)}</div>
                            </div>
                        ` : ''}
                        ${meeting.followUpDate ? `
                            <div style="margin-top: 0.5rem; color: var(--text-secondary);">
                                 Follow-up: ${new Date(meeting.followUpDate).toLocaleDateString()}
                            </div>
                        ` : ''}
                        ${meetingTasks.length > 0 ? `
                            <div class="meeting-tasks">
                                <div class="meeting-tasks-title"> Action Items (${meetingTasks.length})</div>
                                ${meetingTasks.map(task => `
                                    <div class="meeting-task-item">
                                        ${task.completed ? '' : ''} ${escapeHtml(task.title)}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function editMeeting(meetingId) {
            const meeting = state.meetings.find(m => m.id === meetingId);
            if (meeting) {
                openMeetingModal(meeting);
                closeAllMeetingsModal();
            }
        }

        function deleteMeeting(meetingId) {
            showConfirm(
                '',
                'Delete Meeting?',
                'This will delete the meeting notes. Associated tasks will remain but lose their meeting reference.',
                () => {
                    state.meetings = state.meetings.filter(m => m.id !== meetingId);
                    state.tasks.forEach(task => {
                        if (task.meetingId === meetingId) {
                            delete task.meetingId;
                        }
                    });
                    saveData();
                    renderAllMeetings();
                    renderTasks();
                    updateStats();
                    
                    if (state.currentCustomer !== 'all') {
                        showCustomerMeetingsSection(state.currentCustomer);
                    }
                    
                    showToast('Meeting deleted', 'success');
                }
            );
        }

        // Task Modal
        function openTaskModal(task = null) {
            state.editingTask = task;
            state.selectedColor = 'none';
            state.selectedTaskCustomerId = null;
            
            if (task) {
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskCustomerInput').value = task.customerName || '';
                state.selectedTaskCustomerId = task.customerId || null;
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskStatus').value = task.status || 'todo';
                document.getElementById('taskDueDate').value = task.dueDate || '';
                document.getElementById('taskTags').value = task.tags.join(', ');
                document.getElementById('taskColor').value = task.color || 'none';
                document.getElementById('taskMeetingId').value = task.meetingId || '';
                state.selectedColor = task.color || 'none';
                
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                const colorOption = document.querySelector(`.color-option[data-color="${state.selectedColor}"]`);
                if (colorOption) colorOption.classList.add('selected');
                
                const subtasksForm = document.getElementById('subtasksForm');
                subtasksForm.innerHTML = '';
                task.subtasks.forEach(sub => {
                    addSubtaskInput(sub.text, sub.completed);
                });
            } else {
                document.getElementById('taskForm').reset();
                document.getElementById('taskCustomerInput').value = '';
                document.getElementById('subtasksForm').innerHTML = '';
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                document.querySelector('.color-option[data-color="none"]').classList.add('selected');
            }
            document.getElementById('taskModal').classList.add('active');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            state.editingTask = null;
            state.selectedTaskCustomerId = null;
        }

        function addSubtaskInput(text = '', completed = false) {
            const container = document.getElementById('subtasksForm');
            const div = document.createElement('div');
            div.className = 'subtask-input-group';
            div.innerHTML = `
                <input type="text" class="form-input subtask-input" value="${escapeHtml(text)}" placeholder="Subtask...">
                <button type="button" class="btn-remove-subtask" onclick="this.parentElement.remove()"></button>
            `;
            container.appendChild(div);
        }

        function handleTaskSubmit(e) {
            e.preventDefault();
            
            const subtaskInputs = document.querySelectorAll('.subtask-input');
            const subtasks = Array.from(subtaskInputs)
                .map(input => ({ text: input.value.trim(), completed: false }))
                .filter(sub => sub.text);

            const customerInputValue = document.getElementById('taskCustomerInput').value.trim();
            let customerId = state.selectedTaskCustomerId;
            let customerName = customerInputValue;

            if (!customerId && customerInputValue) {
                const existingCustomer = state.customers.find(c => c.name.toLowerCase() === customerInputValue.toLowerCase());
                if (existingCustomer) {
                    customerId = existingCustomer.id;
                    customerName = existingCustomer.name;
                } else {
                    const newCustomer = {
                        id: Date.now().toString(),
                        name: customerInputValue,
                        email: '',
                        phone: '',
                        company: '',
                        notes: '',
                        createdAt: new Date().toISOString()
                    };
                    state.customers.push(newCustomer);
                    customerId = newCustomer.id;
                    customerName = newCustomer.name;
                    showToast('New customer created!', 'success');
                }
            }

            const task = {
                id: document.getElementById('taskId').value || Date.now().toString(),
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                customerId: customerId || null,
                customerName: customerName || '',
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                dueDate: document.getElementById('taskDueDate').value,
                tags: document.getElementById('taskTags').value.split(',').map(t => t.trim()).filter(t => t),
                color: document.getElementById('taskColor').value,
                subtasks: subtasks,
                completed: state.editingTask?.completed || false,
                archived: state.editingTask?.archived || false,
                meetingId: state.editingTask?.meetingId || null,
                createdAt: state.editingTask?.createdAt || new Date().toISOString()
            };

            if (state.editingTask) {
                const index = state.tasks.findIndex(t => t.id === task.id);
                state.tasks[index] = task;
                showToast('Task updated!', 'success');
            } else {
                state.tasks.unshift(task);
                showToast('Task created!', 'success');
            }

            saveData();
            renderTasks();
            updateStats();
            renderCustomerFilters();
            closeTaskModal();
        }

        // Note Modal
        function openNoteModal(note = null) {
            state.editingNote = note;
            if (note) {
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteContent').value = note.content;
            } else {
                document.getElementById('noteForm').reset();
            }
            document.getElementById('noteModal').classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            state.editingNote = null;
        }

        function handleNoteSubmit(e) {
            e.preventDefault();
            
            const note = {
                id: document.getElementById('noteId').value || Date.now().toString(),
                content: document.getElementById('noteContent').value.trim(),
                createdAt: state.editingNote?.createdAt || new Date().toISOString()
            };

            if (state.editingNote) {
                const index = state.notes.findIndex(n => n.id === note.id);
                state.notes[index] = note;
                showToast('Note updated!', 'success');
            } else {
                state.notes.unshift(note);
                showToast('Note created!', 'success');
            }

            saveData();
            renderNotes();
            closeNoteModal();
        }

        // Confirmation Modal
        function showConfirm(icon, title, message, callback) {
            document.getElementById('confirmIcon').textContent = icon;
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            state.confirmCallback = callback;
            
            const confirmBtn = document.getElementById('confirmBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                if (state.confirmCallback) {
                    state.confirmCallback();
                }
                closeConfirmModal();
            });
            
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            state.confirmCallback = null;
        }

        function confirmClearAll() {
            state.tasks = [];
            state.notes = [];
            state.customers = [];
            state.meetings = [];
            state.preparations = [];
            
            localStorage.removeItem('taskflow_tasks');
            localStorage.removeItem('taskflow_notes');
            localStorage.removeItem('taskflow_customers');
            localStorage.removeItem('taskflow_meetings');
            localStorage.removeItem('taskflow_preparations');
            
            render();
            updateStats();
            renderCustomerFilters();
            hideCustomerMeetingsSection();
            hideCustomerPreparationsSection();
            hideCustomerOverview();
            updateSectionTitle();
            
            showToast('All data cleared successfully!', 'success');
        }

        // Task Actions
        function toggleTaskComplete(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.status = 'done';
                } else if (task.status === 'done') {
                    task.status = 'todo';
                }
                saveData();
                renderTasks();
                updateStats();
            }
        }

        function toggleSubtask(taskId, subtaskIndex) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task && task.subtasks[subtaskIndex]) {
                task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                saveData();
                renderTasks();
            }
        }

        function editTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) openTaskModal(task);
        }

        function deleteTask(id) {
            showConfirm(
                '',
                'Delete Task?',
                'Are you sure you want to delete this task? This action cannot be undone.',
                () => {
                    state.tasks = state.tasks.filter(t => t.id !== id);
                    saveData();
                    renderTasks();
                    updateStats();
                    renderCustomerFilters();
                    showToast('Task deleted', 'success');
                }
            );
        }

        function archiveTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.archived = !task.archived;
                saveData();
                renderTasks();
                renderCustomerFilters();
                showToast(task.archived ? 'Task archived' : 'Task unarchived', 'success');
            }
        }

        function changeTaskStatus(taskId, newStatus) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                if (newStatus === 'done') {
                    task.completed = true;
                } else {
                    task.completed = false;
                }
                saveData();
                renderTasks();
                updateStats();
            }
        }

        function showArchived() {
            state.currentView = 'archived';
            document.querySelectorAll('.view-btn[data-view="active"], .view-btn[data-view="archived"]').forEach(b => b.classList.remove('active'));
            document.querySelector('.view-btn[data-view="archived"]').classList.add('active');
            renderTasks();
        }

        // Note Actions
        function editNote(id) {
            const note = state.notes.find(n => n.id === id);
            if (note) openNoteModal(note);
        }

        function deleteNote(id) {
            showConfirm(
                '',
                'Delete Note?',
                'Are you sure you want to delete this note? This action cannot be undone.',
                () => {
                    state.notes = state.notes.filter(n => n.id !== id);
                    saveData();
                    renderNotes();
                    showToast('Note deleted', 'success');
                }
            );
        }

        // Render Functions
        function render() {
            renderTasks();
            renderNotes();
        }

        function renderTasks() {
            if (state.currentDisplayMode === 'kanban') {
                renderKanban();
            } else {
                renderList();
            }
        }

        function renderList() {
            let tasks = state.tasks.filter(t => t.archived === (state.currentView === 'archived'));

            if (state.currentCustomer !== 'all') {
                tasks = tasks.filter(t => t.customerId === state.currentCustomer);
            }

            const today = new Date().toISOString().split('T')[0];
            const weekFromNow = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            switch (state.currentFilter) {
                case 'today':
                    tasks = tasks.filter(t => t.dueDate === today);
                    break;
                case 'week':
                    tasks = tasks.filter(t => t.dueDate && t.dueDate <= weekFromNow);
                    break;
                case 'overdue':
                    tasks = tasks.filter(t => t.dueDate && t.dueDate < today && !t.completed);
                    break;
                case 'high':
                    tasks = tasks.filter(t => t.priority === 'high');
                    break;
            }

            const container = document.getElementById('tasksList');
            const empty = document.getElementById('tasksEmpty');

            if (tasks.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            container.innerHTML = tasks.map((task, index) => createTaskCard(task, index + 1)).join('');
            
            setupDragDrop();
        }

        function renderKanban() {
            let tasks = state.tasks.filter(t => !t.archived);

            if (state.currentCustomer !== 'all') {
                tasks = tasks.filter(t => t.customerId === state.currentCustomer);
            }

            const todoTasks = tasks.filter(t => t.status === 'todo');
            const progressTasks = tasks.filter(t => t.status === 'in-progress');
            const doneTasks = tasks.filter(t => t.status === 'done');

            document.getElementById('todoCount').textContent = todoTasks.length;
            document.getElementById('progressCount').textContent = progressTasks.length;
            document.getElementById('doneCount').textContent = doneTasks.length;

            document.getElementById('todoColumn').innerHTML = todoTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');
            document.getElementById('progressColumn').innerHTML = progressTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');
            document.getElementById('doneColumn').innerHTML = doneTasks.map((task, index) => createTaskCard(task, index + 1, true)).join('');

            setupKanbanDragDrop();
        }

        function setupDragDrop() {
            const tasksList = document.getElementById('tasksList');
            let draggedElement = null;

            tasksList.querySelectorAll('.task-card').forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedElement = card;
                    card.classList.add('dragging');
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    updateTaskOrder();
                });
            });

            tasksList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(tasksList, e.clientY);
                const dragging = document.querySelector('.dragging');
                
                if (afterElement == null) {
                    tasksList.appendChild(dragging);
                } else {
                    tasksList.insertBefore(dragging, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateTaskOrder() {
            const taskElements = document.querySelectorAll('#tasksList .task-card');
            const newOrder = [];
            
            taskElements.forEach(el => {
                const taskId = el.dataset.taskId;
                const task = state.tasks.find(t => t.id === taskId);
                if (task) newOrder.push(task);
            });

            state.tasks = newOrder.concat(state.tasks.filter(t => !newOrder.includes(t)));
            saveData();
            showToast('Task order updated', 'success');
        }

        function setupKanbanDragDrop() {
            const columns = document.querySelectorAll('.kanban-cards');
            
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });

                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    const taskId = e.dataTransfer.getData('text/plain');
                    const newStatus = column.dataset.status;
                    
                    changeTaskStatus(taskId, newStatus);
                });
            });

            const cards = document.querySelectorAll('.kanban-cards .task-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', card.dataset.taskId);
                    card.classList.add('dragging');
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });
        }

        function createTaskCard(task, number, isKanban = false) {
            const today = new Date().toISOString().split('T')[0];
            const threeDays = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            let dueDateClass = '';
            let dueDateText = '';
            
            if (task.dueDate) {
                if (task.dueDate < today && !task.completed) {
                    dueDateClass = 'overdue';
                    dueDateText = ' Overdue';
                } else if (task.dueDate <= threeDays && !task.completed) {
                    dueDateClass = 'due-soon';
                    dueDateText = ' Due soon';
                } else {
                    dueDateText = ` ${task.dueDate}`;
                }
            }

            const colorClass = task.color && task.color !== 'none' ? `color-${task.color}` : '';

            return `
                <div class="task-card ${dueDateClass} ${colorClass}" draggable="true" data-task-id="${task.id}">
                    <div class="task-number">${number}</div>
                    <div class="task-checkbox ${task.completed ? 'completed' : ''}" onclick="event.stopPropagation(); toggleTaskComplete('${task.id}')">
                        <svg viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="task-content">
                        <div class="task-header">
                            <div class="task-title ${task.completed ? 'completed' : ''}">${escapeHtml(task.title)}</div>
                            <div class="task-badges">
                                ${state.currentCustomer === 'all' && task.customerName ? `<span class="task-customer"> ${escapeHtml(task.customerName)}</span>` : ''}
                                ${task.meetingId ? '<span class="task-meeting-badge"> Meeting</span>' : ''}
                                <span class="task-priority priority-${task.priority}">${task.priority}</span>
                            </div>
                        </div>
                        ${task.dueDate ? `<div class="task-due-date ${dueDateClass}">${dueDateText}</div>` : ''}
                        ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                        ${task.subtasks.length > 0 ? `
                            <div class="subtasks-container">
                                ${task.subtasks.map((sub, i) => `
                                    <div class="subtask-item">
                                        <div class="subtask-checkbox ${sub.completed ? 'completed' : ''}" onclick="event.stopPropagation(); toggleSubtask('${task.id}', ${i})"></div>
                                        <span class="subtask-text ${sub.completed ? 'completed' : ''}">${escapeHtml(sub.text)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="task-meta">
                            <div class="task-tags">
                                ${task.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                            <div class="task-actions">
                                <button class="task-btn" onclick="event.stopPropagation(); editTask('${task.id}')" title="Edit">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="task-btn archive" onclick="event.stopPropagation(); archiveTask('${task.id}')" title="Archive">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                                        <rect x="1" y="3" width="22" height="5"></rect>
                                        <line x1="10" y1="12" x2="14" y2="12"></line>
                                    </svg>
                                </button>
                                <button class="task-btn delete" onclick="event.stopPropagation(); deleteTask('${task.id}')" title="Delete">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNotes() {
            const container = document.getElementById('notesList');
            const empty = document.getElementById('notesEmpty');

            if (state.notes.length === 0) {
                container.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            const gradients = [
                'linear-gradient(135deg, #00CEC8 0%, #00A8A3 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            ];

            container.innerHTML = state.notes.map((note, i) => `
                <div class="note-box" style="background: ${gradients[i % gradients.length]}" draggable="true" data-note-id="${note.id}">
                    <div class="note-number">${i + 1}</div>
                    <div class="note-content">${escapeHtml(note.content)}</div>
                    <div class="note-actions">
                        <button class="note-btn" onclick="event.stopPropagation(); editNote('${note.id}')" title="Edit">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="note-btn" onclick="event.stopPropagation(); deleteNote('${note.id}')" title="Delete">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const total = state.tasks.filter(t => !t.archived).length;
            const active = state.tasks.filter(t => !t.completed && !t.archived).length;
            const completed = state.tasks.filter(t => t.completed && !t.archived).length;
            const meetings = state.meetings.length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statActive').textContent = active;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statMeetings').textContent = meetings;
        }

        // Search
        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            if (!query) {
                renderTasks();
                renderNotes();
                return;
            }

            const filteredTasks = state.tasks.filter(t => 
                t.title.toLowerCase().includes(query) ||
                t.description.toLowerCase().includes(query) ||
                (t.customerName && t.customerName.toLowerCase().includes(query)) ||
                t.tags.some(tag => tag.toLowerCase().includes(query))
            );

            const container = document.getElementById('tasksList');
            container.innerHTML = filteredTasks.map((task, index) => createTaskCard(task, index + 1)).join('');
        }

        // Theme
        function toggleTheme() {
            const current = document.body.dataset.theme;
            document.body.dataset.theme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', document.body.dataset.theme);
            showToast('Theme changed', 'success');
        }

        // Storage
        function saveData() {
            localStorage.setItem('taskflow_tasks', JSON.stringify(state.tasks));
            localStorage.setItem('taskflow_notes', JSON.stringify(state.notes));
            localStorage.setItem('taskflow_customers', JSON.stringify(state.customers));
            localStorage.setItem('taskflow_meetings', JSON.stringify(state.meetings));
            localStorage.setItem('taskflow_preparations', JSON.stringify(state.preparations));
        }

        function loadData() {
            const tasks = localStorage.getItem('taskflow_tasks');
            const notes = localStorage.getItem('taskflow_notes');
            const customers = localStorage.getItem('taskflow_customers');
            const meetings = localStorage.getItem('taskflow_meetings');
            const preparations = localStorage.getItem('taskflow_preparations');
            const theme = localStorage.getItem('theme');

            if (tasks) state.tasks = JSON.parse(tasks);
            if (notes) state.notes = JSON.parse(notes);
            if (customers) state.customers = JSON.parse(customers);
            if (meetings) state.meetings = JSON.parse(meetings);
            if (preparations) state.preparations = JSON.parse(preparations);
            if (theme) document.body.dataset.theme = theme;
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // Utility
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        init();

        // Auto-save
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html>
